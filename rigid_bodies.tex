\documentclass[aip,jcp,reprint,amsmath,amssymb]{revtex4-1}

\usepackage[pdftex]{graphicx}
\usepackage[]{threeparttable}

\newcommand{\mt}[1]{\boldsymbol{\mathbf{#1}}}           % matrix symbol
\newcommand{\vt}[1]{\boldsymbol{\mathbf{#1}}}           % vector symbol
\newcommand{\tr}[1]{#1^\text{t}}                        % transposition
\newcommand{\diff}[2]{\dfrac{\partial #1}{\partial #2}} % partial derivative

\newcommand{\sn}{\text{sn}}                             % Jacobi function sn
\newcommand{\cn}{\text{cn}}                             % Jacobi function cn
\newcommand{\dn}{\text{dn}}                             % Jacobi function dn

\newenvironment{smallarray}[1]                          % small arrays
{\null\,\vcenter\bgroup\scriptsize
	\renewcommand{\arraystretch}{1.5}
	\arraycolsep=.13885em
	\hbox\bgroup$\left[\array{@{}#1@{}}}
{\endarray\right]$\egroup\egroup\,\null}

\begin{document}

\title{A Simplified Formulation for Molecular Dynamics with Rigid Bodies}

\author{Ana J. Silveira}
\email{asilveira@plapiqui.edu.ar}
\affiliation{Planta Piloto de Ingenier\'ia Qu\'imica, PLAPIQUI, Universidad Nacional del Sur, Camino La Carrindanga Km 7-CC: 717, Bah\'ia Blanca, Argentina}

\author{Charlles R. A. Abreu}
\email{abreu@eq.ufrj.br}
\affiliation{Chemical Engineering Department, Escola de Qu\'imica, Universidade Federal do Rio de Janeiro, Rio de Janeiro, RJ 21941-909, Brazil}

\date{\today}

\begin{abstract}
In Molecular Dynamics, sets of atoms collectively behaving as rigid bodies are often used to model entire molecules or parts thereof. Such a coarse-graining strategy eliminates degrees of freedom and admits larger time steps without abandoning the atomistic character of a model. In this paper, we rely on a particular factorization of the rotation matrix to simplify the mechanics of systems containing rigid molecules. Then, we present equations of motion and devise time-reversible, measure-preserving integrators for both microcanonical (NVE) and canonical (NVT) dynamics. We also develop new expressions for computing the virial pressure of rigid-body systems under periodic boundary conditions. Finally, simulations of liquid water are employed to analyze the numerical aspects of the proposed methodology.
\end{abstract}

\maketitle

\section{Introduction}

Along with advances in software and hardware, improvements in molecular dynamics (MD) algorithms have allowed researchers to extend both the time and the length scales attainable in atomistic simulations. This progress has fomented the ambitious attempt of elucidating complex physical phenomena such as the mechanisms underlying molecular motors, pathways for nanoparticle assembly, and interfacial phenomena, to name just a few. Because of its complexity and large computational demand, such a challenging task requires strategies to enlarge the achievable scales even further.

One of the strategies employed to speed up MD simulations is the suppression of unimportant degrees of freedom, as might be the case of intramolecular vibrations. Iterative methods such as SHAKE\cite{Ryckaert1977} and RATTLE\cite{Andersen1983} achieved this suppression by adding constraints to the equations of motion. This is the standard approach in the common case of molecular models with fixed bond lengths and bending angles, but flexible dihedral angles. However, for molecules modeled as rigid structures or those containing rigid substructures,\cite{Miller2002} the dynamics of rigid bodies emerges as a suitable approach. This is expected to be computationally more efficient because the constraints are treated implicitly. In addition, and most importantly, it is possible to devise symplectic integrators for simulations in the microcanonical ensemble. Being symplectic implies phase-space volume preservation and time reversibility, which are sufficient conditions for numerical integrators to be used in hybrid Monte Carlo (HMC) methods.\cite{Duane1987} In this context, Miller \textit{et al}.\cite{Miller2002} have introduced a symplectic integrator for the rotational motion represented in terms of unit quaternions. This approach has been successfully employed in plain MD as well as in HMC methods to simulate a wide variety of systems composed of rigid molecules, including liquid water,\cite{Sakamaki2011, Reinhardt2012, Palmer2014, Gonzales2014} ice,\cite{Geiger2014} hydrates,\cite{Tribello2009, Gorman2012} gases diffusing in metal-organic frameworks,\cite{Ghoufi2010} and so forth. It has also been applied for molecules designed as collections of interconnected rigid bodies, which is a coarse-graining strategy used for proteins,\cite{Terada2003}, molecular machines,\cite{Akimov2008, Konyukhov2010} nanoparticles,\cite{Knorowski2012, Patra2013} etc.

In this paper, we present a simplified formulation for the motion of rigid bodies in the microcanonical (NVE) and canonical (NVT) ensembles, as well as numerical integrators for both cases. Our contribution in the NVE case resides on a factorization of the rotation matrix that allows a Hamiltonian formalism to be devised without the need of extending the rotational phase space, thus simplifying the formulation of Miller \textit{et al}.\cite{Miller2002} In the NVT case, both the translational and rotational degrees of freedom are simultaneously coupled to a unique Nos\'e-Hoover chain (NHC) thermostat. This differs from the approach of Kamberaj \textit{et al}.,\cite{Kamberaj2005} in which two thermostat chains act separately on the rotational and the translational degrees of freedom. We also simplify the calculation of pressure for systems with rigid bodies whose constituent atoms interact via a pairwise potential under periodic boundary conditions. For this, we derive two alternative expressions: one that depends exclusively on the resultant interaction forces between body pairs and one that corrects the pressure calculated in terms of interactions among freely moving atoms.

The paper is organized as follows. In Sec.~\ref{sec:mechanics}, we present a mathematical reformulation of the Hamiltonian equations of motion for rigid bodies in terms of unit quaternions. In Sec.~\ref{sec:molecular_dynamics}, we devise numerical integrators for both the NVE and NVT dynamics, whose performance and correctness we assess in Sec.~\ref{sec:numerical_results}. Moreover, we present results related to kinetic energy partition in the NVE case, analyze the statistical distributions of the sampled energies in the NVT case, and check the equation we developed for computing pressure. Finally, we present some concluding remarks in Sec.~\ref{sec:conclusion}.

Throughout this paper, we use the word ``quaternion'' as a synonym for a four-dimensional vector, avoiding other interpretations. Thus, only ordinary matrix/vector operations are present in the formulation. Some mathematical details are given in the Appendix.

\section{Mechanics of Rigid Body Motion}
\label{sec:mechanics}

In this section, we first review certain aspects of the kinematics of rigid bodies which are relevant to the present study. Unit quaternions are employed to represent the orientations of rigid bodies. Then, we introduce the use of a particular factorization of the rotation matrix, from which a mathematical relation arises between the rate of change of a four-dimensional quaternion and a three-dimensional angular velocity vector. An important feature of this relation is that it preserves the unit-norm constraint of a quaternion upon infinitesimal rotation.

\subsection{Kinematics}
\label{sec:kinematics}

Consider a rigid body composed of $n_p$ individual particles, with each particle $j$ having mass $M_j$ and being located at a Cartesian coordinate $\vt R_j$. The center of mass of this body is located at
\begin{equation*}
\vt r = \frac{1}{m}\sum_{j=1}^{n_p} M_j {\vt R}_j,
\end{equation*}
where $m = \sum_{j=1}^{n_p} M_j$ is the total mass of the body. The position of each particle $j$ in a space-fixed frame of reference, whose origin coincides with the body's center of mass, is ${\vt \delta}_j = \tr{ [\begin{array}{ccc} {\delta_j}_x & {\delta_j}_y & {\delta_j}_z \end{array}]} = {\vt R}_j - {\vt r}$. In such frame, the symmetric inertia tensor for rotations of the body about the origin is\cite{Goldstein2002}
\begin{equation*}
{\mt I}^\ast = \sum_{j=1}^N M_j \begin{smallarray}{ccc}
{\delta_j}_y^2 + {\delta_j}_z^2 & -{\delta_j}_x {\delta_j}_y & -{\delta_j}_x {\delta_j}_z \\
-{\delta_j}_y {\delta_j}_x & {\delta_j}_x^2 + {\delta_j}_z^2 & -{\delta_j}_y {\delta_j}_z \\
-{\delta_j}_z {\delta_j}_x & -{\delta_j}_z {\delta_j}_y & {\delta_j}_x^2 + {\delta_j}_y^2 \\
\end{smallarray}.
\end{equation*}

For every non-collinear rigid body (for conciseness, the only case considered here), there exists a particular frame of reference in which its inertia tensor is diagonal. The formulation of the equations of motion in this frame of reference is notably simplified. Conversions from the space-fixed frame to such a body-fixed frame are performed by a rotation matrix $\mt A$ that satisfies the similarity relation\cite{Goldstein2002}
\begin{equation*}
{\mt I} = {\mt A} {\mt I}^\ast \tr{\mt A} = \begin{smallarray}{ccc}
I_1 &   0 &   0 \\
0 & I_2 &   0 \\
0 &   0 & I_3 \\
\end{smallarray},
\end{equation*}
where $I_1$, $I_2$, and $I_3$ (the eigenvalues of ${\mt I}^\ast$) are the principal moments of inertia and the columns of $\tr{\mt A}$ (the corresponding eigenvectors) are the principal axes of rotation. With no loss of generality, we can consider that $I_1 \geq I_2 \geq I_3$. Algorithms for obtaining $\mt A$ from $\mt I^\ast$ can be found in the literature (e.g. Ref.~\onlinecite{Kopp2008}). Once this is done, the position of every particle $j$ in the body-fixed frame can be obtained by ${\vt d}_j = {\mt A} {\vt \delta}_j$. Since $\mt A$ represents an orthogonal transformation, a conversion in the opposite direction is done by ${\vt \delta}_j = \tr{\mt A} {\vt d}_j$.\cite{Goldstein2002} This is so because $\mt A \tr{\mt A} = \mt 1_3$, where $\mt 1_k$ represents a $k \times k$ identity matrix. By differentiating both sides of this relation with respect to time, we conclude that ${\mt A} \tr{\dot{\mt A}} = -\dot{\mt A} \tr{\mt A}$, which means that the result of $\mt A \tr{\dot{\mt A}}$ is skew-symmetric. The angular velocity of the body expressed in the body-fixed frame, $\vt \omega$, is related to this product by $\mt S(\vt \omega) = \mt A \tr{\dot{\mt A}}$,\cite{Haug1989} where $\mt S(\cdot)$ is the skew-symmetric operator defined in Appendix \ref{sec:auxiliary_math}  (Eq.~\ref{eq:operator_S}).

An arbitrary rotation can be described using three independent parameters. One can use Euler angles, for instance, but mathematical singularities arise when the equations of motion are described in such terms. Instead, we consider an alternative representation, in which the orientation of a rigid body is given by four parameters $q_1$, $q_2$, $q_3$, and $q_4$, often referred to as Euler parameters, which form a quaternion $\vt q = \tr {[\begin{array}{cccc} q_1 & q_2 & q_3 & q_4 \end{array}]}$ and satisfy the relation\cite{Goldstein2002}
\begin{equation}
\label{eq:norm_eq_1}
\tr{\vt q}{\vt q} = \|\vt q\|^2 = q_1^2 + q_2^2 + q_3^2 + q_4^2 = 1.
\end{equation}

Therefore, $\vt q$ is restricted to the surface of a unit hypersphere in $\mathbb{R}^4$, which is itself a three-dimensional domain. Methods are available for computing the unit quaternion related to a given rotation matrix (e.g. Ref.~\onlinecite{Shepperd1978}). Reversely, the matrix $\mt A$ can be directly computed from a given unit quaternion $\vt q$ by\cite{Allen1989,Miller2002}
\begin{equation*}
\label{eq:A_from_q}
\mt A(\vt q) = \begin{smallarray}{ccc}
q_1^2 + q_2^2 - q_3^2 - q_4^2 & 2(q_2 q_3 + q_1 q_4) & 2(q_2 q_4 - q_1 q_3) \\
2(q_2 q_3 - q_1 q_4) & q_1^2 - q_2^2 + q_3^2 - q_4^2 & 2(q_3 q_4 + q_1 q_2) \\
2(q_2 q_4 + q_1 q_3) & 2(q_3 q_4 - q_1 q_2) & q_1^2 - q_2^2 - q_3^2 + q_4^2  
\end{smallarray}.
\end{equation*}

Differentiating Eq.~\ref{eq:norm_eq_1} with respect to time yields
\begin{equation}
\label{eq:diff_qTq}
\tr{\vt q}\dot{\vt q} = 0,
\end{equation}
which implies that, for Eq.~\ref{eq:norm_eq_1} to be preserved upon an infinitesimal motion, the rate of change $\dot{\vt q}$ must lie in the hyperplane orthogonal to $\vt q$.

Let us now introduce two new matrix-valued functions that depend on the quaternion components as
\begin{equation}
\label{eq:def_B_and_C}
\mt B(\vt q) = \begin{smallarray}{rrrr}
-q_2 & -q_3 & -q_4 \\
 q_1 & -q_4 &  q_3 \\
 q_4 &  q_1 & -q_2 \\
-q_3 &  q_2 &  q_1
\end{smallarray}
\; \text{and} \;
\mt C(\vt q) = \begin{smallarray}{rrrr}
-q_2 & -q_3 & -q_4 \\
 q_1 &  q_4 & -q_3 \\
-q_4 &  q_1 &  q_2 \\
 q_3 & -q_2 &  q_1
\end{smallarray}.
\end{equation}

Some important properties of these matrices (or transposes thereof) have been reported in the literature\cite{Haug1989, Shuster1993, Dichmann1999, Ravishankar2004, Nielsen2012} and are revisited with our particular notation in Appendix~\ref{sec:auxiliary_math}. The most remarkable feature is that
\begin{equation}
\label{eq:factorization_of_A}
{\mt A} = \tr{\mt B}{\mt C}.
\end{equation}

The equation above is a simple and convenient factorization of matrix $\mt A$, since the entries of both $\mt B$ and $\mt C$ depend linearly on the Euler parameters. As demonstrated in Appendix~\ref{sec:auxiliary_math}, this factorization provides a relation between the angular velocity vector $\vt \omega$ and the rates of change of the quaternion components, which is
\begin{equation}
\label{eq:relation_qdot_omega}
\dot{\vt q} = \frac{1}{2} \mt B \vt \omega.
\end{equation}

Note that, for simplicity, we might omit the argument of a matrix-valued function (like $\mt A$, $\vt B$, or $\mt C$) when such argument is $\vt q$. It is explained in Appendix~\ref{sec:auxiliary_math} that premultiplication of a vector with either $\mt B$ or $\mt C$ transforms it into a quaternion that lies in the hyperplane orthogonal to $\vt q$ and that both transformations can be reversed by applying $\tr{\vt B}$ or $\tr{\vt C}$ accordingly. Therefore, there exists an intermediary frame of reference, which is fixed with respect to the unit quaternion $\vt q$ that represents the orientation of the body. Its connection to the body-fixed and space-fixed frames are summarized as follows:
\[
\boxed{\substack{\text{Body-fixed} \\ \text{frame}}}
\mathrel{\mathop{\rightleftarrows}^{\mt B}_{\tr{\mt B}}}
\boxed{\substack{\text{Quaternion-fixed} \\ \text{frame}}}
\mathrel{\mathop{\rightleftarrows}^{\tr{\mt C}}_{\mt C}}
\boxed{\substack{\text{Space-fixed} \\ \text{frame}}}
\]

Hence, Eq.~\ref{eq:relation_qdot_omega} shows that $\dot{\vt q}$ is half the quaternion-fixed version of the angular velocity vector. Besides, it guarantees that the norm of $\vt q$ remains unchanged because Eq.~\ref{eq:diff_qTq} is identically satisfied.

To conclude this section, we discuss on the possibility of switching between alternative space-fixed frames when describing the motion of a rigid body. This will be useful when we deal with torque-free rotations (Sec.~\ref{sec:free_rotation}). Consider that a body-fixed vector $\vt d$ is simultaneously observed as $\vt \delta = \tr{\mt A\!}(\vt q){\vt d}$ in a space-fixed frame $\mathcal S_q$ and as $\vt \xi = \tr{\mt A\!}(\vt z){\vt d}$ in another space-fixed frame $\mathcal S_z$. It follows that $\vt \xi = \mt A(\vt g)\vt \delta$, where the composite rotation matrix $\mt A(\vt g) = \tr{\mt A\!}(\vt z){\mt A}(\vt q)$ denotes the relative orientation between $\mathcal S_q$ and $\mathcal S_z$. One key result in quaternion algebra\cite{Dichmann1999} is a simple relation that exists between $\vt q$, $\vt z$, and $\vt g$, which can be adapted to our notation as $\vt g = \tr{[\begin{array}{cc}\vt z & \mt C(\vt z)\end{array}]} \vt q$. Note that both $\vt q$ and $\vt z$ vary while the body rotates, but the quaternion $\vt g$ remains constant because $\mathcal S_q$ and $\mathcal S_z$ are fixed in space. Moreover, as Eq.~\ref{eq:relation_qdot_omega} was derived for an arbitrary space-fixed frame, it is also true that $\dot{\vt z} = \tfrac{1}{2}{\vt B}(\vt z)\vt \omega$. In conclusion, as an alternative to tracking the evolution of $\vt q(t)$ after an instant $t_0$ in which $\vt q = \vt q_0$, one can select some other convenient unit quaternion $\vt z_0$ and then track the evolution of $\vt z(t)$, starting from $\vt z(t_0) = \vt z_0$. Then, whenever $\vt q$ is needed, one can simply make 
\begin{equation}
\label{eq:relation_q_z}
\vt q = [\begin{array}{cc}\vt z & \mt C(\vt z)\end{array}] \tr{[\begin{array}{cc}\vt z_0 & \mt C(\vt z_0)\end{array}]} \vt q_0,
\end{equation}
which is correct because these block matrices represent orthogonal transformations in $\mathbb{R}^4$.

\subsection{Hamiltonian Dynamics}
\label{sec:hamiltonian}

The relation between $\vt q$ and $\vt \omega$ (Eq.~\ref{eq:relation_qdot_omega}) is used here to develop a Hamiltonian formalism for the motion of a rigid body. As usual, it can be described by detaching translation and rotation, represented by ${\vt r}(t)$ and ${\vt q}(t)$, respectively. The position of each particle $j$ will vary with time as $\vt r_j(t) = \vt r(t) + \tr{[{\mt A}(\vt q(t))]}\vt d_j$. Several authors have obtained Hamiltonian equations for the rotation of rigid bodies using quaternions as generalized coordinates.\cite{Maciejewski1985, Dichmann1996, Miller2002, Ravishankar2004, Nielsen2012} Here we try to combine convenient features of their formulations. We start by defining the Lagrangian $\mathcal{L} = K - U$ as a function of $\vt r$, $\dot{\vt r}$, $\vt q$, and $\dot{\vt q}$, where $K$ and $U$ are the kinetic and potential energies of the body, respectively. Since $K = \frac{1}{2} m \tr{\dot{\vt r}} \dot{\vt r} + \frac{1}{2} \tr{\vt \omega} \mt I \vt \omega$,\cite{Goldstein2002} we can resort to Eq.~\ref{eq:relation_qdot_omega} to write
\begin{equation*}
\mathcal{L} = \frac{1}{2} m \tr{\dot{\vt r}} \dot{\vt r} + 2 \tr{\dot{\vt q}} \mt B \mt I \tr{\mt B} \dot{\vt q} - U(\vt r, \vt q).
\end{equation*}

To employ the Hamiltonian approach, besides the linear momentum $\vt p = \partial \mathcal{L}/\partial \dot{\vt r} = m \dot{\vt r}$, conjugated to $\vt r$, we introduce the momentum $\vt \pi = \partial \mathcal{L}/\partial \dot{\vt q}$, conjugated to $\vt q$.\cite{Goldstein2002} By carrying out the differentiation (see Appendix \ref{sec:Diff_Rules}), we get
\begin{equation}
\label{eq:conj_momentum}
\vt \pi = 4 \mt B \mt I \tr{\mt B} \dot{\vt q} = 2 \mt B \mt I \vt \omega.
\end{equation}

Hence, $\vt \pi$ is twice the quaternion-fixed version of the angular momentum $\vt L = \mt I \vt \omega$ and, as such, it is also orthogonal to $\vt q$. Using the relation above, we can write down the Hamiltonian $\mathcal{H} = K + U$ as a function of $\vt r$, $\vt p$, $\vt q$, and $\vt \pi$, which is
\begin{equation}
\label{eq:H_with_B}
\mathcal{H} = \frac{\tr{\vt p} \vt p}{2m} + \frac{\tr{\vt \pi} {\mt B} {\mt I}^{-1} \tr{\mt B} \vt \pi}{8} + U(\vt r, \vt q).
\end{equation}

The equations of motion are obtained from the Hamiltonian by $\dot{\vt r} = \partial \mathcal{H} / \partial \vt p$, $\dot{\vt p} = -\partial \mathcal{H} / \partial \vt r$, $\dot{\vt q} = \partial \mathcal{H} / \partial \vt \pi$, and $\dot{\vt \pi} = -\partial \mathcal{H} / \partial \vt q$.\cite{Goldstein2002} Eq.~\ref{eq:H_with_B} is convenient for differentiation with respect to $\vt \pi$, since $\mt B(\vt q)$ does not depend on it. However, if we define $\mt \Omega = \mt B(\vt \pi)$, it follows that $\tr{\mt B}{\vt \pi} = - \tr{\mt \Omega}{\vt q}$ and, therefore, a convenient form of $\mathcal{H}$ for differentiation with respect to $\vt q$ is
\begin{equation}
\label{eq:H_with_Omega}
\mathcal{H} = \frac{\tr{\vt p} \vt p}{2m} + \frac{\tr{\vt q} {\mt \Omega} {\mt I}^{-1} \tr{\mt \Omega} \vt q}{8} + U(\vt r, \vt q).
\end{equation}

For a rigid body composed of $n_p$ individual particles, the derivative $\partial U/\partial \vt r$ is obtained by
\[
\diff{U}{\vt r} = -\vt F = -\sum_{j=1}^{n_p} {\vt F_j},
\]
where $\vt F_j$ is the force applied on particle $j$, expressed in the space-fixed frame of reference (see Appendix \ref{sec:Diff_PotEng}), and thus $\vt F$ is the resultant force on the body. To obtain the derivative $\partial U/\partial \vt q$, one must take into account that the entries of $\vt q$ are not independent, due to the constraint imposed by Eq.~\ref{eq:norm_eq_1}. The correct way of performing differentiation with respect to a constrained vector is described in Ref.~\onlinecite{Schay1995}. As demonstrated in Appendix \ref{sec:Diff_PotEng}, we have
\[
\diff{U}{\vt q} = -2 \mt C \vt \tau = -2 \mt C \sum_{j=1}^{n_p} {\vt \delta_j} \times {\vt F_j},
\]
where $\vt \tau$ is the resultant torque exerted on the body, also expressed in the space-fixed frame. Therefore, $-\partial U/\partial \vt q$ is twice the torque represented in quaternion-fixed frame of reference. Finally, after carrying out the required differentiations of $\mathcal{H}$ using either Eq.~\ref{eq:H_with_B} or Eq.~\ref{eq:H_with_Omega} (see Appendix~\ref{sec:Diff_Rules}) and substituting $\tr{\mt B} \vt \pi = - \tr{\mt \Omega} \vt q = 2 {\mt I} \vt \omega$, we obtain the following Hamiltonian system of equations of motion for a rigid body:
\begin{subequations}
\label{eq:EDO_system}
\begin{align}
&\dot{\vt r} = \frac{1}{m} \vt p \\
&\dot{\vt p} = \mt F \\
&\dot{\vt q} = \frac{1}{2} \mt B \vt \omega \label{eq:EDO_q} \\
&\dot{\vt \pi} = \frac{1}{2} \mt \Omega \vt \omega + 2 \mt C \vt \tau \label{eq:EDO_pi}
\end{align}
\end{subequations}

Anticipating a feature that will be convenient in the forthcoming sections, we now consider the entries of $\vt \omega$ individually. Given that $2{\mt I}{\vt \omega} = \tr{\mt B}{\vt \pi}$, according to Eq.~\ref{eq:vector_entries}, each entry of $\vt \omega$ is obtained by
\begin{equation}
\label{eq:omega_entry}
\omega_k = \frac{\tr{\vt \pi} \hat{\mt B}_k \vt q}{2 I_k},
\end{equation}
where $\hat{\mt B}_k$ is one of the permutation matrices presented in Appendix~\ref{sec:auxiliary_math}. In this context, the Hamiltonian of the rigid body can be rewritten as
\begin{equation}
\label{eq:H_split_omega}
\mathcal{H} = \frac{\tr{\vt p} \vt p}{2m} + U(\vt r, \vt q) + \frac{1}{2} \sum_{k=1}^3 I_k \omega_k^2.
\end{equation}

Finally, we open the products $\mt B \vt \omega$ and $\mt \Omega \vt \omega$ as in Eq.~\ref{eq:product_B_vector}, which leads us to the following new form for the equations of motion in Eqs.~\ref{eq:EDO_q} and \ref{eq:EDO_pi}:
\begin{subequations}
\label{eq:EDO_system_alternative}
\begin{align}
&\dot{\vt q} = \frac{1}{2} \sum_{k=1}^3 \omega_k \hat{\mt B}_k \vt q \label{eq:edo_q} \\
&\dot{\vt \pi} = \frac{1}{2} \sum_{k=1}^3 \omega_k \hat{\mt B}_k \vt \pi + 2 \mt C \vt \tau \label{eq:edo_pi}
\end{align}
\end{subequations}

\subsection{Analytical Solution for Free Rotation}
\label{sec:free_rotation}

It is not possible to analytically integrate the equations of motion for a general potential $U(\vt r,\vt q)$. Nonetheless, closed-form solutions for Eqs.~\ref{eq:EDO_q} and \ref{eq:EDO_pi} are known for the particular case of torque-free rotation (i.e. when $\vt \tau = \vt 0$). Free rotations are very useful in Molecular Dynamics as part of numerical integration methods based on splitting strategies, which is the topic addressed in Sec.~\ref{sec:symplectic}. As shown in Appendix~\ref{sec:derivation_euler}, Eq.~\ref{eq:EDO_pi} results in the well-known Euler equation $\mt I \dot{\vt \omega} + \vt \omega \times (\mt I \vt \omega) = \mt A \vt \tau$, which is completely decoupled from Eq.~\ref{eq:EDO_pi} when $\vt \tau = \vt 0$. It is a known fact that both the rotational energy $K_r = \frac{1}{2}\tr{\vt \omega}{\mt I}{\vt \omega}$ and the space-fixed angular momentum vector $\vt L$ (whose squared norm is $L^2 = \tr{\vt \omega}{\mt I}^2{\vt \omega}$) are integrals of motion in a free rotation. This allows us to analytically solve the Euler equation for the angular velocity vector $\vt \omega$. Here we present the solution for an asymmetric top ($I_1 > I_2 > I_3$) in a form that aims to facilitate computer implementation, inspired by the derivations presented in Refs.~\onlinecite{Landau1976} and \onlinecite{Thorn2012}. From an initial condition $\vt \omega(0) = \vt \omega_0 = \tr{[\omega_1^0 \; \omega_2^0 \; \omega_3^0]}$, such solution starts by computing $K_r = \frac{1}{2}\tr{\vt \omega_0}{\mt I}{\vt \omega}_0$ and $L = (\tr{\vt \omega_0}{\mt I}^2{\vt \omega_0})^{1/2}$, followed by evaluating a vector of prefactors defined as
\begin{equation*}
\vt a = \begin{smallarray}{c}
\frac{\omega_1^0}{\sqrt{1 - \left(\omega_2^0/\lambda_1\right)^2}} \\
\min(\lambda_1,\lambda_3) \\
\frac{\omega_3^0}{\sqrt{1 - (\omega_2^0/\lambda_3)^2}}
\end{smallarray},
\; \text{where} \;
\begin{cases}
\lambda_1 = \sqrt{\frac{L^2 - 2 I_3 K_r}{I_2(I_2 - I_3)}} \\
\lambda_3 = \sqrt{\frac{2 I_1 K_r - L^2}{I_2(I_1 - I_2)}}
\end{cases}.
\end{equation*}

Note that the value of $a_2$ depends on a comparison between $\lambda_1$ and $\lambda_3$. This also occurs for $\vt \omega$, whose functional form is
\begin{subequations}
\begin{align}
\vt \omega(t) &= \begin{smallarray}{c}
a_1\text{cn}(\omega_p t + \epsilon, k^2) \\
a_2\text{sn}(\omega_p t + \epsilon, k^2) \\
a_3\text{dn}(\omega_p t + \epsilon, k^2)
\end{smallarray} \quad \text{if} \quad \lambda_1 < \lambda_3 \quad \text{or} \\
\vt \omega(t) &= \begin{smallarray}{c}
a_1\text{dn}(\omega_p t + \epsilon, k^2) \\
a_2\text{sn}(\omega_p t + \epsilon, k^2) \\
a_3\text{cn}(\omega_p t + \epsilon, k^2)
\end{smallarray} \quad \text{if} \quad \lambda_1 > \lambda_3,
\end{align}
\end{subequations}
where $\text{sn}(u,m)$, $\text{cn}(u,m)$, and $\text{dn}(u,m)$ are the Jacobi elliptic functions,\cite{Byrd_1971} $k = {a_2}/{\text{max}(\lambda_1,\lambda_3)}$ is the elliptic modulus, and the constants $\omega_p$ and $\epsilon$ are given by
\begin{equation*}
\omega_p = -\frac{(I_1 - I_3)a_1 a_3}{I_2 a_2} \quad \text{and} \quad
\epsilon = \text{sn}^{-1}\left(\frac{\omega_2^0}{a_2}, k^2\right).
\end{equation*}

In order to compute the inverse function $\text{sn}^{-1}$, one can use its relation with an elliptic integral in Carlson form, \cite{Carlson_1977} $\text{sn}^{-1}(x,m) = x R_F(1-x^2,1-mx^2,1)$. In this work, we employ the routines available in Ref.~\onlinecite{Galassi_2009} for numerically evaluating Jacobi functions and Carlson integrals.

Once $\vt \omega$ is known as a function of time, we can solve Eq.~\ref{eq:EDO_q} with initial condition $\vt q(0) = \vt q_0$. The method we propose here, which is closely related to the one pioneered by Kosenko\cite{Kosenko_1998} and extended by Celledoni \textit{et al}.,\cite{Celledoni_2008} relies on the factorization in Eq.~\ref{eq:factorization_of_A} to facilitate the task. During a free rotation, any space-fixed representation of the angular momentum vector will remain constant. Thus, instead of solving Eq.~\ref{eq:EDO_q} directly for obtaining $\vt q$, we solve an analogous equation for obtaining another unit quaternion $\vt z$ specially chosen so that $\tr{[\mt A(\vt z)]}\mt I\vt \omega = \tr{[\begin{array}{ccc} L & 0 & 0 \end{array}]}$. In other words, we look for an alternative space-fixed frame whose first axis is aligned with the angular momentum vector.


\begin{equation*}
\mt B(\vt z)\mt I\vt \omega = \mt C(\vt z)\begin{smallarray}{c}
L \\ 0 \\ 0
\end{smallarray}
\end{equation*}

By making ${\mt A}(\vt z) = \mt A(\vt z)\mt C(\vt z)$

factorizing $\mt A(\vt z)$ and applying Eq.~\ref{eq:product_B_vector}, we obtain a homogeneous linear system
\begin{equation*}
\Big(L \hat{\vt C}_1 - \sum_{j=1}^3 I_j \omega_j \hat{\vt B}_j\Big) \vt z = \vt 0,
\end{equation*}
where $\hat{\vt C}_1$ and $\hat{\vt B}_k$ are the permutation matrices introduced in Appendix~\ref{sec:auxiliary_math}. Hence, besides having unit norm, the quaternion $\vt z$ will always lie in the null space of a matrix $\mt G = L \hat{\vt C}_1 - \sum_{j=1}^3 I_j \omega_j \hat{\vt B}_j$, which is guaranteed to exist because $\det \mt G = (L^2 - \tr{\vt \omega}{\mt I}^2{\vt \omega})^2 = 0$. Such a null space turns out to be a moving hyperplane in $\mathbb{R}^4$ defined by the orthogonal basis vectors
\begin{equation*}
\vt v_1(t) = \begin{smallarray}{c}
\frac{I_3\omega_3(t)}{L-I_1\omega_1(t)} \\
\frac{I_2\omega_2(t)}{L-I_1\omega_1(t)} \\
1 \\
0
\end{smallarray}
\quad \text{and} \quad
\vt v_2(t) = \begin{smallarray}{c}
\frac{-I_2\omega_2(t)}{L-I_1\omega_1(t)} \\
\frac{I_3\omega_3(t)}{L-I_1\omega_1(t)} \\
0 \\
1
\end{smallarray}.
\end{equation*}

At all times, therefore, $\vt z$ will be a linear combination of $\vt v_1$ and $\vt v_2$. As these basis vectors are known functions of time, the problem of determining $\vt z(t)$ reduces to finding out how the two coefficients of the combination vary with time. Examination of $\vt v_1$ and $\vt v_2$ above makes it clear that these coefficients coincide with the entries $z_3$ and $z_4$ of $\vt z$, in such a way that
\begin{equation}
\label{eq:linear_comb_z}
\vt z(t) = z_3(t) \vt v_1(t) + z_4(t) \vt v_2(t).
\end{equation}

Note that we are free to choose any unit quaternion in the hyperplane defined by $\vt v_1(0)$ and $\vt v_2(0)$ as the initial condition $\vt z(0) = \vt z_0$. In other words, we can select any space-fixed frame whose first axis aligns with the angular momentum vector. For convenience, we choose
\begin{equation*}
\vt z_0 = \frac{\vt v_1(0)}{\|\vt v_1(0)\|} = \sqrt{\frac{L - I_1\omega_1^0}{2L}} \vt v_1(0).
\end{equation*}

By substituting Eq.~\ref{eq:linear_comb_z} into $\dot{\vt z} = \frac{1}{2}{\mt B}(\vt z){\vt \omega}$, which is the equivalent of Eq.~\ref{eq:EDO_q} for $\vt z$, we obtain a vector of four differential equations containing $z_3$ and $z_4$, from which we pick the third and fourth ones, which are linearly independent. After replacing $(I_2 - I_3)\omega_2\omega_3 = I_1\dot{\omega}_1$ and $I_1\omega_1^2 + I_2\omega_2^2 + I_3\omega_3^2 = 2 K_r$, followed by defining
\begin{equation*}
\mt M(t) = \begin{smallarray}{rr} f(t) & -g(t) \\ g(t) & f(t) \end{smallarray} \; \text{with} \;
\begin{cases}
f(t) = \frac{-I_1 \dot{\omega}_1(t)}{L - I_1\omega_1(t)} \\
g(t) = \frac{2K_r - L\omega_1(t)}{L - I_1\omega_1(t)}
\end{cases},
\end{equation*}
we can represent these equations in matrix form as
\begin{equation*}
\begin{smallarray}{c} \dot{z}_3 \\ \dot{z}_4 \end{smallarray} = \frac{1}{2} {\mt M}(t) \begin{smallarray}{c} z_3 \\ z_4 \end{smallarray}.
\end{equation*}

It is fortunate that the product $\mt M(t_a)\mt M(t_b)$ commutes for any $t_a$ and $t_b$, since this is a sufficient condition for a solution to be obtained in terms of matrix exponential $\exp[\frac{1}{2}\int_0^t \mt M(\tau)d\tau]$. Such solution is
\begin{equation*}
\begin{smallarray}{c} z_3 \\ z_4 \end{smallarray} = \sqrt{\tfrac{L-I_1\omega_1(t)}{L-I_1\omega_1^0}} \begin{smallarray}{rr} \cos \phi(t) & -\sin \phi(t) \\ \sin \phi(t) & \cos \phi(t) \end{smallarray} \begin{smallarray}{c} z_3^0 \\ z_4^0 \end{smallarray},
\end{equation*}
where $\phi(t) = \frac{1}{2} \int_0^t g(\tau)d\tau$. Note that this consists in a counterclockwise rotation, followed by a scaling.

\begin{align*}
z_3(t) &= \sqrt{\tfrac{L-I_1\omega_1(t)}{2L}} \cos \phi(t) \\
z_4(t) &= \sqrt{\tfrac{L-I_1\omega_1(t)}{2L}} \sin \phi(t)
\end{align*}

\begin{equation*}
\phi(t) = \frac{L}{2 I_1\omega_p}\left\{(A_\phi + 1)\omega_p t + A_\phi[h(t) - h(0)]\right\},
\end{equation*}
where $A_\phi = \frac{2 I_1 K_r - L^2}{L^2 - I_1^2 a_1^2}$ and $B_\phi = \frac{\max(\lambda_1,\lambda_3)}{\sqrt{\lambda_1^2 + \eta \lambda_3^2}}$, $C_\phi = \frac{\lambda_1\lambda_3}{a_3 \sqrt{\lambda_1^2 + \eta \lambda_3^2}}$. The function $h(t)$ is defined as
\begin{align*}
h(t) &= \Theta\left(\frac{\omega_2(t)}{a_2},-\frac{a_2^2 }{\lambda_1^2}\eta,k^2\right) + \\
&+ \frac{I_1}{L} \frac{a_1 a_3}{a_2} C_\phi \arctan\left(C_\phi\frac{\omega_3(t)}{\omega_2(t)}\right)
\end{align*}

But $\frac{a_1 a_3}{a_2} = - \frac{I_2}{I_1 - I_3} \omega_p$. Thus,
\begin{align*}
h(t) &= \Theta\left(\frac{\omega_2(t)}{a_2},-\frac{a_2^2 }{\lambda_1^2}\eta,k^2\right) \\
&- \frac{I_1 \omega_p}{L}\frac{I_2 C_\phi}{I_1 - I_3} \arctan\left(C_\phi\frac{\omega_3(t)}{\omega_2(t)}\right)
\end{align*}

Rewriting $g(t)$:
\begin{equation*}
g(t) = \frac{L}{I_1} + \frac{2 I_1 K_r - L^2}{L I_1 \omega_p}\frac{\omega_p}{1 + \alpha[\omega_1(t)/a_1]},
\end{equation*}
where $I_1 a_1/L$. By defining $u = \omega_p \tau + \epsilon$, we have that $du = \omega_p d\tau$. Therefore, if $\lambda_1 < \lambda_3$:
\begin{equation*}
\phi(t) = \frac{L}{2I_1}t + \frac{2 I_1 K_r - L^2}{2L I_1 \omega_p}\int\limits_\epsilon^{\omega_p t + \epsilon} \frac{1}{1 + \alpha \cn u}du
\end{equation*}

Otherwise, if $\lambda_3 < \lambda_1$:
\begin{equation*}
\phi(t) = \frac{L}{2I_1}t + \frac{2 I_1 K_r - L^2}{2L I_1 \omega_p}\int\limits_\epsilon^{\omega_p t + \epsilon} \frac{1}{1 + \alpha \dn u}du
\end{equation*}

From Ref.~\onlinecite{Byrd_1971}, we deduce that
\begin{align*}
\int \frac{1}{1 + \alpha \cn u}du = (\eta + 1) \Bigg[\Pi(\sn u,-\eta,k^2) + \\
+ \frac{\alpha}{\sqrt{k^2+\eta}}\arctan\left(\frac{\dn u}{\sn u \sqrt{k^2+\eta}}\right)\Bigg]
\end{align*}

Given that $\cn(u,k^2) = \dn(ku,1/k^2)$, $\dn(u,k^2) = \cn(ku,1/k^2)$, and $\sn(ku,1/k^2) = k\sn(u,k^2)$
\begin{align*}
\int \frac{1}{1 + \alpha \dn u}du = \frac{\eta + 1}{k} \Bigg[\Pi(k\sn u,-\eta,1/k^2) + \\
+ \frac{\alpha}{\sqrt{1/k^2+\eta}}\arctan\left(\frac{\cn u}{k \sn u \sqrt{1/k^2+\eta}}\right)\Bigg]
\end{align*}
where $\eta = \frac{\alpha^2}{1-\alpha^2}$. Moreover, as $\Pi(x,y,z) = k\Pi(x/k,yk^2,zk^4)$:
\begin{align*}
\int \frac{1}{1 + \alpha \dn u}du = (\eta + 1) \Bigg[\Pi(\sn u,-k^2\eta,k^2) + \\
+ \frac{\alpha}{k\sqrt{1/k^2+\eta}}\arctan\left(\frac{\cn u}{k \sn u \sqrt{1/k^2+\eta}}\right)\Bigg]
\end{align*}


\begin{widetext}
\begin{equation*}
\phi(t) = \frac{L}{2 I_1\omega_p}\left\{(A_\phi + 1)\omega_p t + A_\phi [h(t) - h(0)]\right\},
\end{equation*}
\begin{equation}
h(t) = \Theta\left(\frac{\omega_2(t)}{a_2},-\frac{a_2^2 }{\lambda_1^2}\eta,k^2\right) + \alpha B_\phi \arctan\left(B_\phi\frac{\omega_3(t)/a_3}{\omega_2(t)/a_2}\right)
\end{equation}
where $A_\phi = \frac{2 I_1 K_r - L^2}{L^2}(\eta + 1)$ and $B_\phi = \frac{\max(\lambda_1,\lambda_3)}{\sqrt{\lambda_1^2 + \eta \lambda_3^2}}$
	
	
	
\begin{equation*}
\phi(t) = \frac{L}{2I_1}t + \frac{2 I_1 K_r - L^2}{2 b I_1 L} (\eta + 1) \Bigg[bt + \Theta\left(\frac{\omega_2(t)}{a_2},-\frac{a_2^2 \eta}{\lambda_1^2},k^2\right) + \frac{\alpha}{\sqrt{k^2+\eta}}\arctan\left(\frac{\dn u}{\sn u \sqrt{k^2+\eta}}\right)\Bigg]
\end{equation*}

\begin{equation*}
\phi(t) = \frac{L}{2}\frac{2K_r - I_1 a_1^2}{L^2 - I_1^2 a_1^2}t + \frac{2 I_1 K_r - L^2}{2 b I_1 L} (\eta + 1) \Bigg[bt + \Theta\left(\frac{\omega_2(t)}{a_2},-\frac{a_2^2 \eta}{\lambda_1^2},k^2\right) + \frac{\alpha}{\sqrt{k^2+\eta}}\arctan\left(\frac{\dn u}{\sn u \sqrt{k^2+\eta}}\right)\Bigg]
\end{equation*}

\end{widetext}
where $\alpha = I_1 a_1/L$.

\begin{align*}
\int \frac{1}{1 + \alpha \cn u}du = (\eta + 1) \Bigg[u + \Theta(\sn u,-\eta,k^2) + \\
+ \frac{\alpha}{\sqrt{k^2+\eta}}\arctan\left(\frac{\dn u}{\sn u \sqrt{k^2+\eta}}\right)\Bigg]
\end{align*}

\begin{align*}
\int \frac{1}{1 + \alpha \dn u}du = (\eta + 1) \Bigg[u + \Theta(\sn u,-k^2\eta,k^2) + \\
+ \frac{\alpha}{k\sqrt{1/k^2+\eta}}\arctan\left(\frac{\cn u}{k \sn u \sqrt{1/k^2+\eta}}\right)\Bigg]
\end{align*}

-----

\begin{equation*}
\left[\begin{array}{c}
\dot{z}_3 \\
\dot{z}_4
\end{array}\right] =
\frac{1}{2}\left[\begin{array}{rr}
f(t) & g(t) \\
-g(t) & f(t)
\end{array}\right]
\left[\begin{array}{c}
z_3 \\
z_4
\end{array}\right],
\end{equation*}
where $f(t) = \frac{-I_1 \dot{\omega}_1(t)}{L - I_1\omega_1(t)}$ and $g(t) = \frac{2K_r - L\omega_1(t)}{L - I_1\omega_1(t)}$. Because the product $\mt M(t_a)\mt M(t_b)$, where $\mt M(t)$ is the matrix above, commutes for any instants $t_a$ and $t_b$, since this is a sufficient condition for 
\begin{equation*}
\left[\begin{array}{c}
z_3 \\
z_4
\end{array}\right] =
\exp \Bigg( \frac{1}{2}\left[\begin{array}{rr}
f(t) & g(t) \\
-g(t) & f(t)
\end{array}\right] \Bigg)
\left[\begin{array}{c}
z_3^0 \\
z_4^0
\end{array}\right],
\end{equation*}


Note that 


The remaining terms of Eq.~\ref{eq:linear_comb_z} are 


\begin{align*}
f(t) &= \frac{-I_1 \dot{\omega}_1(t)}{L - I_1\omega_1(t)} \\
g(t) &= \frac{L}{I_1} + \frac{2 I_1 K_r - L^2}{b I_1 L}\frac{b}{1+(I_1 a_1/L)[\omega_1(t)/a_1]}
\end{align*}

 two linearly independent ones.

Those corresponding to the third and forth elements of $\vt v_1$ and $\vt v_2$

\begin{equation*}
\dot{\vt z} = \frac{1}{2} {\mt B}(\vt z){\vt \omega} = \frac{1}{2}\left(\sum_{j=1}^3 \omega_j \hat{\mt B}_j\right){\vt z}.
\end{equation*}

\begin{equation*}
\dot{z}_3 \vt v_1 + \dot{z}_4 \vt v_2 + z_3 \dot{\vt v}_1 + z_4 \dot{\vt v}_2 = \frac{1}{2}{\mt B}(z_3 \vt v_1 + z_4 \vt v_2){\vt \omega}.
\end{equation*}

------

, which are, in fact, the elements $z_3(t)$ and $z_4(t)$.

. Simple examination of these vectors makes evident that $\vt z = z_3 \vt v_1 + z_4 \vt v_2$, which means that 

the coefficients of such combination clearly coincide with the elements $z_3$ and $z_4$.

\begin{equation*}
\vt q = \left[\begin{array}{cc}\vt z & \mt C(\vt z)\end{array}\right]\tr{\left[\begin{array}{cc}\vt z_0 & \mt C(\vt z_0)\end{array}\right]} \vt q_0.
\end{equation*}

Any unit quaternion in the hyperplane defined by $\vt v_1(0)$ and $\vt v_2(0)$ can be taken as $\vt z(0) = \vt z_0$.

\begin{equation*}
\vt z_0 = \frac{1}{\sqrt{2L(L - I_1\omega_1^0)}}
\left[\begin{array}{c}
I_3\omega_3^0 \\
I_2\omega_2^0 \\
L-I_1\omega_1^0 \\
0
\end{array}\right].
\end{equation*}



, that is, $\vt z = z_3 \vt v_1 + z_4 \vt v_2$. 


This reduces the problem to determining 




\begin{equation*}
\vt z = z_3 \vt v_1 + z_4 \vt v_2 =
\left[\begin{array}{c}
\frac{I_3\omega_3z_3 - I_2\omega_2z_4}{L-I_1\omega_1} \\
\frac{I_2\omega_2z_3 + I_3\omega_3z_4}{L-I_1\omega_1} \\
z_3 \\
z_4
\end{array}\right]
\end{equation*}
Such null space certainly exists because .

Given that $(I_2 - I_3)\omega_2\omega_3 = I_1 \dot{\omega}_1$ and $\tr{\vt \omega}\mt I\vt \omega = K_r$:
\begin{align*}
\dot{z}_3 = \frac{1}{2}\frac{I_1\dot{\omega}_1 z_3 + (2K_r + L\omega_1)z_4}{L + I_1\omega_1} \\
\dot{z}_4 = \frac{1}{2}\frac{I_1\dot{\omega}_1 z_4 - (2K_r + L\omega_1)z_3}{L + I_1\omega_1}
\end{align*}

From Eq.~\ref{eq:factorization_of_A}, we observe that $\mt B(\vt z)\mt I\vt \omega = \mt C(\vt z)\tr{[L \; 0 \; 0]}$.

A key aspect of the approach consists in defining is the choice of a temporary space-fixed frame of reference 

Let $\vt L = \tr{[\mt A(\vt q)]}{\mt I}{\vt \omega}$ be the angular momentum vector 

$\vt L = \tr{[\mt A(\vt q)]}{\mt I}{\vt \omega}$ remains constant while both the quaternion $\vt q$ and the body-fixed angular velocity $\vt \omega$ vary.


 Once $\vt L$ is computed from the initial condition and the evolution of $\vt \omega$ is known (after solving the Euler equation), this fact constrains the possible evolution of $\vt q$. By premultiplying $\vt L$ by $\vt C$, one has that $\vt C \vt L = \vt B \mt I \vt \omega$. In other words, $\vt q$ must vary in such a way that the mapping of both $\vt L$ and $\mt I\vt \omega$ in its orthogonal plane always coincide. Then, resorting to Eq.~\ref{eq:product_B_vector} we can write
\begin{equation*}
\sum_{k=1}^3\left(L_k \hat{\vt C}_k - I_k \omega_k \hat{\vt B}_k\right){\vt q} = \vt 0,
\end{equation*}
where $\hat{\vt C}_k$ and $\hat{\vt B}_k$ are the permutation matrices defined in Appendix~\ref{sec:auxiliary_math}.
Therefore, $\vt q$ is constrained to lie in the null space of a matrix $\mt G = \sum_{k=1}^3(L_k \hat{\vt C}_k - I_k \omega_k \hat{\vt B}_k)$. The determinant of this matrix can be obtained as
\begin{equation*}
\det \mt G = (\tr{\vt \omega}{\mt I}^2{\vt \omega} - L^2)^2,
\end{equation*}
which is identically null in a free rotational motion. In fact, this is a requirement for a matrix to have a non-empty null space. Using a computer algebra package, it is straightforward to find out that $\vt G$ has a two-dimensional null space whose basis set is formed by the two vectors
\begin{equation*}
\vt v_1 = \begin{smallarray}{c}
L_2 + I_2 \omega_2 \\
L_3 - I_3 \omega_3 \\
0 \\
L_1 - I_1 \omega_1
\end{smallarray}
\quad \text{and} \quad
\vt v_1 = \begin{smallarray}{c}
L_3 + I_3 \omega_3 \\
L_2 - I_2 \omega_2 \\
L_1 - I_1 \omega_1 \\
0
\end{smallarray}.
\end{equation*}

\begin{equation*}
\exp\left(-\begin{smallarray}{cc}
 \alpha(t) & \phi(t) \\
-\phi(t) & \alpha(t)
\end{smallarray}\right) = 
e^{-\alpha(t)} \begin{smallarray}{cc}
\cos \phi(t) & -\sin \phi(t) \\
\sin \phi(t) &  \cos \phi(t)
\end{smallarray}
\end{equation*}

Here,
\begin{equation}
\alpha(t) = \frac{1}{2}\int_0^t \frac{I_1 \omega_1^\prime(\tau)}{L - I_1\omega_1(\tau)}d\tau =
\frac{1}{2}\ln\left(\frac{L - I_1\omega_1}{L - I_1\omega_1^0}\right)
\end{equation}

\begin{equation}
\varphi(t) = \frac{1}{2}\int_0^t \frac{2 K_r + L \omega_1(\tau)}{L + I_1\omega_1(\tau)}d\tau
\end{equation}

After some algebra\cite{Celledoni_2008}
\begin{equation*}
\varphi(t) = \frac{L}{2I_1}t + \frac{2 I_1 K_r - L^2}{2 I_1 L}\int_0^t \frac{1}{1+(I_1/L)\omega_1(\tau)}d\tau.
\end{equation*}

If $\lambda_1 < \lambda_3$, then $\omega_1(t) = A_1 \text{cn}(\alpha t + \epsilon)$

\begin{align*}
\int \frac{1}{1 + \alpha \cn u}du = (\eta + 1) \Bigg[u + \Theta(\sn u,-\eta,k^2) + \\
+ \frac{\alpha}{\sqrt{k^2+\eta}}\arctan\left(\frac{\dn u}{\sn u \sqrt{k^2+\eta}}\right)\Bigg]
\end{align*}

\begin{align*}
\int \frac{1}{1 + \alpha \dn u}du = (\eta + 1) \Bigg[u + \Theta(\sn u,-k^2\eta,k^2) + \\
+ \frac{\alpha}{k\sqrt{1/k^2+\eta}}\arctan\left(\frac{\cn u}{k \sn u \sqrt{1/k^2+\eta}}\right)\Bigg]
\end{align*}

\begin{align*}
\Theta(x,n,m) &= \Pi(x,n,m) - \text{sn}^{-1}(x,m) = \\
&= \frac{1}{3}nx^3R_J(1-x^2,1-mx^2,1,1-nx^2).
\end{align*}


\subsection{Symplectic Numerical Integration}
\label{sec:symplectic}

An exact solution of Eq.~\ref{eq:EDO_system_alternative} would describe a symplectic form in the phase space determined by $\vt r$, $\vt p$, $\vt q$, and $\vt \pi$. Hence, the described dynamics would be time-reversible and preserve both the Hamiltonian and the phase-space volume element. Even though one cannot obtain a closed-form solution for Eq.~\ref{eq:EDO_system_alternative}, it is possible to derive a symplectic approximate solution by applying the Liouville operator formalism.\cite{Tuckerman2010} For a given trajectory in phase space, any function $f(\vt r, \vt p, \vt q, \vt \pi)$ will vary with time according to
\begin{equation*}
\dot{f} = \left( \tr{\dot{\vt r}} \diff{}{\vt r} + \tr{\dot{\vt p}} \diff{}{\vt p} + \tr{\dot{\vt q}} \diff{}{\vt q} + \tr{\dot{\vt \pi}} \diff{}{\vt \pi} \right) f = i\!L f,
\end{equation*}
where $i\!L$ is the Liouville operator. This equation has a formal solution expressed by $f(t) = e^{t i\!L}f_0$, where $f_0$ is the initial value of $f$. As $f$ can be a phase-space coordinate, the exponential operator $e^{t i\!L}$, known as the classical time-evolution propagator,\cite{Tuckerman2008} represents a transformation from the initial condition to the phase-space point occupied at time $t$. Nevertheless, as no analytical solution is known for Eq.~\ref{eq:EDO_system_alternative}, the actual effect of its corresponding propagator cannot be determined.

Analytical solutions exist for some simpler hypothetical cases related to Eq.~\ref{eq:EDO_system_alternative}. Let us analyze three of them, which will be useful later on to derive a complete approximate solution. In what follows, an index $0$ stands for ``initial value''. We start by considering a hypothetical Hamiltonian $\mathcal{H}_t = (1/2m) \tr{\vt p} \vt p$, whose resulting equations of motion are $\dot{\vt r} = {\vt p}/m$, $\dot{\vt p} = 0$, $\dot{\vt q} = 0$, and $\dot{\vt \pi} = 0$. The exact solution for this case is
\[
{\vt r}(t) = {\vt r}_0 + \frac{t}{m} {\vt p}_0,
\]
with ${\vt p}(t) = {\vt p}_0$, ${\vt q}(t) = {\vt q}_0$, and ${\vt \pi}(t) = {\vt \pi}_0$. This corresponds to a free translation (hence the subscript $t$). As the momentum $\vt p$ remains constant, the Hamiltonian $\mathcal{H}_t$ is conserved, as expected. Of course, the solution above is the exact effect of the propagator $e^{t i\!L_t}$, where the Liouville operator $i\!L_t$ is, simply,
\[
i L_t = \frac{\tr{\vt p}}{m}\diff{}{\vt r}.
\]

In the second hypothetical case, referred to as the boost case, we consider a Hamiltonian $\mathcal{H}_b = U(\vt r, \vt q)$. The resulting equations of motion are $\dot{\vt r} = 0$, $\dot{\vt p} = \vt F$, $\dot{\vt q} = 0$, and $\dot{\vt \pi} = 2 \mt C \vt \tau$, whose exact solution is
\begin{align*}
&{\vt p}(t) = {\vt p}_0 + t \vt F \\
&{\vt \pi}(t) = {\vt \pi}_0 +  2 t \mt C \vt \tau
\end{align*}
with ${\vt r}(t) = {\vt r}_0$ and ${\vt q}(t) = {\vt q}_0$. As $\vt r$ and $\vt q$ remain unaltered, $\vt F$, $\mt C$, and $\vt \tau$ are constant as well. This solution clearly conserves $\mathcal{H}_b$ and marks the effect of a propagator $e^{t i\!L_b}$, obtained from the operator
\[
i\!L_b = \tr{\vt F} \diff{}{\vt p} + 2 \tr{\vt \tau} \tr{\mt C} \diff{}{\vt \pi}.
\]

Finally, the third hypothetical case consists of a Hamiltonian $\mathcal{H}_k = (1/2) I_k \omega_k^2$. Note that a single entry of $\vt \omega$ is accounted for in this case, so that it corresponds to a free uniaxial rotation. The equations of motion resulting from $\mathcal{H}_k$ are $\dot{\vt r} = 0$, $\dot{\vt p} = 0$, $\dot{\vt q} = \frac{1}{2} \omega_k \hat{\mt B}_k \vt q$, and $\dot{\vt \pi} = \frac{1}{2} \omega_k \hat{\mt B}_k \vt \pi$. A special feature of this system facilitates its solution. It is known beforehand that the solution will keep $\mathcal{H}_k$ unaltered and, as a consequence, $\omega_k$ will be a constant as well. As noticed by Miller~\textit{el al.}~\cite{Miller2002}, this decouples the equations for $\dot{\vt q}$ and $\dot{\vt \pi}$, which are identical in form. The analytical solution that takes place is\cite{Miller2002}
\begin{align*}
&{\vt q}(t) = \cos\left(\frac{\omega_k t}{2}\right) \vt q_0 + \sin\left(\frac{\omega_k t}{2}\right) \hat{\mt B}_k \vt q_0 \\
&{\vt \pi}(t) = \cos\left(\frac{\omega_k t}{2}\right) \vt \pi_0 + \sin\left(\frac{\omega_k t}{2}\right) \hat{\mt B}_k \vt \pi_0
\end{align*}
with ${\vt r}(t) = {\vt r}_0$ and ${\vt p}(t) = {\vt p}_0$. These equations, with $\omega_k$ calculated from $\vt q_0$ and $\vt \pi_0$ using Eq.~\ref{eq:omega_entry}, represent the effect of a propagator $e^{t i\!L_k}$ derived from the operator
\[
i\!L_k = \frac{1}{2} \omega_k \left( \tr{\vt q}\tr{\hat{\mt B}_k} \diff{}{\vt q} + \tr{\vt \pi}\tr{\hat{\mt B}_k} \diff{}{\vt \pi} \right).
\]

Now note that the Hamiltonian in Eq.~\ref{eq:H_split_omega} is equal to the sum ${\mathcal H}_t + {\mathcal H}_b + \sum_{k=1}^3 {\mathcal H}_k$, so that the Liouville operator corresponding to the original case of Eq.~\ref{eq:EDO_system_alternative} can be written as
\begin{align}
\label{eq:full_operator}
i\!L = i\!L_t + i\!L_b + \sum_{k=1}^3 i\!L_k.
\end{align}

The Trotter-Suzuki splitting formula\cite{Trotter1959, Suzuki1976} can be used to devise a numerical solution for the rigid body motion which preserves the symplectic structure of Eq.~\ref{eq:EDO_system_alternative}. For a sum of two operators $i\!L_A$ and $i\!L_B$, such formula is
\[
e^{t(i\!L_A + i\!L_B)} \approx \left( e^{\frac{\Delta t}{2} i\!L_B} e^{\Delta t i\!L_A} e^{\frac{\Delta t}{2} i\!L_B} \right)^\mathcal{N} + \mathcal{O}(\Delta t^2),
\]
where $\Delta t = t/\mathcal N$ is the time step size and $\mathcal N$ is the number of steps. We recall that each exponential operator above will act having as initial condition the result of the operator at its right-hand side. By defining $i\!L_r = \sum_{k=1}^3 i\!L_k$ as the Liouville operator for a complete free rotation and realizing that the operators $i\!L_r$ and $i\!L_t$ are commutable, the factorization we employ here for the Liouville operator in Eq.~\ref{eq:full_operator} is
\begin{equation}
\label{eq:trotter_splitting_NVE}
e^{\Delta t i\!L} = e^{\frac{\Delta t}{2} i\!L_b} e^{\Delta t i\!L_r} e^{\Delta t i\!L_t} e^{\frac{\Delta t}{2} i\!L_b}.
\end{equation}

Update of forces and torques is required only after the free translation and free rotation have been carried out. Each complete rotation is split as\cite{Miller2002}
\begin{equation}
\label{eq:splitting_rot}
e^{\Delta t i\!L_r} = \prod_{j=1}^n \left( e^{\frac{\delta t_j}{2} i\!L_3} e^{\frac{\delta t_j}{2} i\!L_2} e^{\delta t_j i\!L_1} e^{\frac{\delta t_j}{2} i\!L_2} e^{\frac{\delta t_j}{2} i\!L_3} \right),
\end{equation}
where $\sum_{j=1}^n {\delta t}_j = \Delta t$. This means that free rotation, which is computationally inexpensive for not involving force calculations, can be carried out with a smaller time step for accuracy improvement. Following Miller \textit{et al}.,\cite{Miller2002} one could simply make $\delta t_j = \Delta t/n$ for all $j$. Alternatively, one could use a higher-order factorization scheme, such as the one due to Yoshida\cite{Yoshida1990} and Suzuki,\cite{Suzuki1991a, Suzuki1991b} in which $\delta t_j = \omega_j \Delta t$ and the weights $\omega_j$ are carefully chosen to determine the order of approximation. It is our intention in this paper to investigate how the performance of the integrator as a whole is affected by using such a higher-order scheme. For that, we will consider $n = 1$ with $\omega_1 = 1$ (zero-order) and $n = 7$ with $\omega_1 = \omega_7 = 0.784513610477560$, $\omega_2 = \omega_6 = 0.235573213359357$, $\omega_3 = \omega_5 = -1.17767998417887$, and $\omega_4 = 1 - \sum_{j \neq 4} \omega_j$ (sixth-order).

Finally, we remark that an analytical solution for the complete rotation exists\cite{vanZon2007} and that splitting schemes with higher-order approximations have been used for rigid body dynamics.\cite{Omelyan2007, Omelyan2008, vanZon2008} However, they result in methods that are more complex and often require expensive force-gradient calculations. Moreover, it is unclear how their benefits would extend to non-Hamiltonian numerical integrators, as required for molecular dynamics in ensembles other than the microcanonical one.

\section{Molecular Dynamics}
\label{sec:molecular_dynamics}

In this section, we present factorization schemes for generating molecular dynamics algorithms in the microcanonical (NVE) and canonical (NVT) ensembles. In both cases, a three-dimensional system is considered as consisting of $N$ interacting, non-collinear rigid bodies occupying a fixed volume $V$. An index $i$ ranging from $1$ to $N$ indicates the quantities related to each body, including its generalized coordinates ($\vt r_i$ and $\vt q_i$) and conjugate momenta ($\vt p_i$ and $\vt \pi_i$). Thus, the phase space of the whole system now contains $3N$ spatial coordinates and $4N$ quaternion components, along with their $7N$ conjugate momenta. Of course, $2N$ implicit constraints are known to exist, as $\tr{\vt q}_i{\vt q}_i = 1$ and $\tr{\vt q}_i{\vt \pi}_i = 0$ for all $i$.

\subsection{Microcanonical Ensemble}

Considering the system described above, with $\vt r$ and $\vt q$ now representing the combined sets of all coordinates and quaternion components, we define the Hamiltonian
\begin{equation}
\label{eq:H_NVE}
\mathcal{H} = U(\vt r,\vt q) + \sum_{i=1}^N \left(\frac{\tr{\vt p}_i{\vt p}_i}{2m_i} + \frac{\tr{\vt \pi}_i {\mt B}_i {\mt I}_i^{-1} \tr{\mt B}_i {\vt \pi}_i}{8}\right).
\end{equation}

As usual, sampling of a microcanonical ensemble can be carried out by a Hamiltonian dynamics in phase space, which will have $\mathcal{H} = E$ as an integral of motion. The dynamics of this system is governed by a Liouville operator expressed as in Eq.~\ref{eq:full_operator}, but now with individual operators defined as
\[
\begin{split}
i\!L_b &= \sum_{i=1}^N \left( \tr{\vt F}_i \diff{}{\vt p_i} + 2 \tr{\vt \tau}_i \tr{\mt C}_i \diff{}{\vt \pi_i} \right), \\
i\!L_t &= \sum_{i=1}^N \frac{\tr{\vt p}_i}{m_i}\diff{}{\vt r_i}, \quad \text{and} \\
i\!L_k &= \frac{1}{2} \sum_{i=1}^N {\omega_i}_k \left( \tr{\vt q}_i\tr{\hat{\mt B}_k} \diff{}{\vt q_i} + \tr{\vt \pi_i}\tr{\hat{\mt B}_k} \diff{}{\vt \pi_i} \right).
\end{split}
\]

Therefore, a symplectic integrator can be devised using the same splitting scheme of Sec.~\ref{sec:symplectic}, with the action of each propagator (boost, free translation, and free uniaxial rotation) occurring simultaneously for all rigid bodies in the system. If there are no external forces acting on the bodies, then additional conserved quantities are the total linear momentum $\sum_{i=1}^N \vt p_i = \vt P$ and the generator of infinitesimal Galilean boosts\cite{Ray1999, Schwichtenberg2015} $\sum_{i=1}^N(\vt p_i t - m_i \vt r_i) = \boldsymbol{\mathcal G}$. If periodic boundary conditions are employed, as it is usual in molecular dynamics simulations, then there is no rotational symmetry and, consequently, no conservation of the total angular momentum.

\subsection{Canonical Ensemble}
\label{sec:canonical}

Knowledge about the dynamics and statistical mechanics of non-Hamiltonian systems has advanced considerably in recent years.\cite{Tuckerman_1999, Tuckerman2001, Sergi2001, Sergi2003, Ezra2004, Sergi2004, Ezra2006, Sergi2010b} In this context, invaluable tools have been devised for the development and analysis of simulation methods based on the concept of extended phase space. Sergi and Ferrario\cite{Sergi2001} describe a simple way of systematically generating conservative trajectories in an arbitrary phase space. If vector $\vt x$ represents a phase-space point, $H(\vt x)$ is a scalar field, and $\boldsymbol{\mathcal B}(\vt x)$ is a matrix-valued function, then the equation of motion
\begin{equation} \label{eq:eq_of_motion}
\dot{\vt x} = \boldsymbol{\mathcal B}\diff{H}{\vt x}
\end{equation}
will generate a flow that conserves the value of $H$, provided that $\boldsymbol{\mathcal B}$ is skew-symmetric (that is, $\tr{ \boldsymbol{ \mathcal B }} = -\boldsymbol{ \mathcal B }$). A generalized Liouville operator can then be defined as\cite{Sergi2004}
\[
i\!L = \tr{\dot{\vt x}}\diff{}{\vt x} = \tr{\left(\diff{H}{\vt x}\right)} \tr{\boldsymbol{\mathcal B}} \diff{}{\vt x}.
\]

The system might exhibit a non-vanishing phase-space compressibility $\kappa(\vt x) = \sum_j \partial \dot{x}_j/\partial x_j$ if any variable in $\vt x$ affects its own time-derivative. According to Tuckerman and coworkers,\cite{Tuckerman_1999, Tuckerman2001} although the phase-space volume element $d\vt x$ is no longer conserved, there exits an invariant measure $e^{-w(\vt x)}d\vt x$, where $w(\vt x)$ is the indefinite time integral of $\kappa(\vt x)$. Using the generalized Liouville operator, such relation between $\kappa$ and $w$ can be written as
\begin{equation}
\label{eq:relation_kappa_w}
\kappa = \dot w = i\!L w.
\end{equation}

We employ the technique of Sergi and Ferrario\cite{Sergi2001} to couple a single Nos\'e-Hoover chain\cite{Martyna1992} (NHC) composed of $M$ thermostats to a system of $N$ rigid bodies. This is simpler than the approach of Kamberaj \textit{et al}.,\cite{Kamberaj2005} who employed two thermostat chains independently coupled to the translational and rotational degrees of freedom. To this end, we consider extra coordinates $\eta_j$ and their conjugate momenta $p_{\eta_j}$, for $j$ ranging from $1$ to $M$. The conserved ``extended Hamiltonian'' in this case is
\begin{equation}
\label{eq:H_nvt}
H = \mathcal{H}(\vt r,\vt p,\vt q,\vt \pi) + \sum_{j=1}^{M}\frac{p_{\eta_j}^2}{2Q_j} + L k_b T\eta_1 + k_b T\sum_{j=2}^M \eta_j,
\end{equation}
where $\mathcal H$ is the same as in Eq.~\ref{eq:H_NVE}, $k_b T$ is the Boltzmann constant multiplied by the system temperature, $L$ is a constant to be determined, and each $Q_j$ is an inertial parameter of thermostat $j$. As recommended in Ref.~\onlinecite{Martyna1992}, one can make $Q_1 = L k_b T t_d^2$ and $Q_j = k_b T t_d^2$ for $j \geq 2$, where $t_d$ is a characteristic time scale of the system. The equations of motion regarding generalized coordinates are identical to those of a Hamiltonian system, i.e. $\dot{\vt r}_i = {\partial H}/{\partial \vt p_i}$ and $\dot{\vt q}_i = {\partial H}/{\partial \vt \pi_i}$ for every particle $i$ and $\dot{\eta}_j = {\partial H}/{\partial {p_\eta}_j}$ for every thermostat $j$. However, the equations of motion for generalized momenta contain non-Hamiltonian terms. For instance, the first thermostat of the chain acts on the translational and rotational momenta of each particle $i$ as
\[
\begin{split}
\dot{\vt p}_i &= -\diff{H}{\vt r_i} - {\vt p}_i \diff{H}{p_{\eta_1}} \quad \text{and} \\
\dot{\vt \pi}_i &= -\diff{H}{\vt q_i} - {\vt \pi}_i \diff{H}{p_{\eta_1}}.
\end{split}
\]

In the right-hand side of each equation above, the first term fulfills the skew-symmetry condition with respect to the corresponding coordinate while the second term enacts the coupling with the mentioned thermostat. In turn, the equation of motion for $p_{\eta_1}$ must contain terms to ensure skew-symmetry with respect to the equations already shown, along with a term regarding the action of a second thermostat. The result is
\[
{\dot p}_{\eta_1} = \sum_{i=1}^N \left( \tr{\vt p_i} \diff{H}{\vt p_i} + \tr{\vt \pi_i} \diff{H}{\vt \pi_i}\right) - \diff{H}{\eta_1} - p_{\eta_1} \diff{H}{p_{\eta_2}}.
\]

Each additional thermostat will then act on the preceding one, and be acted upon by the succeeding one. Therefore, for $j$ from $2$ to $M-1$, the equations of motion are
\[
{\dot p}_{\eta_j} = -\diff{H}{\eta_j} + p_{\eta_{j-1}} \diff{H}{p_{\eta_{j-1}}} - p_{\eta_j} \diff{H}{p_{\eta_{j+1}}}.
\]

Finally, as the last thermostat will just act on the previous one, its equation of motion can be obtained by simply replacing $j = M$ and removing the last term in the equation above. Therefore, if we take all the required derivatives (including those described in Sec.~\ref{sec:hamiltonian}), the equations of motion for a system of rigid bodies coupled to a single Nos\'e-Hoover chain become
\begin{subequations}
\label{eq:nhc_system}
\begin{align}
&\dot{\vt r}_i = \frac{{\vt p}_i}{m_i} \\ 
&\dot{\vt p}_i = {\vt F}_i - \alpha_1 \vt p_i \label{eq:nhc_p} \\
&\dot{\vt q}_i = \frac{1}{2} \mt B_i \vt \omega_i \label{eq:nhc_q} \\
&\dot{\vt \pi}_i = \frac{1}{2} \mt \Omega_i \vt \omega_i + 2 \mt C_i \vt \tau_i - \alpha_1 \vt \pi_i \label{eq:nhc_pi} \\
&\dot{\eta}_j = \alpha_j \label{eq:nhc_eta} \\
&{\dot p}_{\eta_j} = G_j - \alpha_{j+1} p_{\eta_j}  \label{eq:nhc_p_eta}
\end{align}
\end{subequations}

In the equations above, ${\vt \omega}_i = \frac{1}{2} {\mt I}_i^{-1} \tr{\mt B}_i {\vt \pi}_i$, $\alpha_j = {p_{\eta_j}}/{Q_j}$ for $j \leq M$ and $\alpha_{M+1} = 0$, while
\begin{align*}
&G_1 = \sum_{i=1}^N \left( \frac{\tr{\vt p}_i{\vt p}_i}{m_i} + \tr{\vt \omega}_i \mt I_i \vt \omega_i \right) - L k_b T \quad \text{and}\\
&G_j = \frac{p_{\eta_{j-1}}^2}{Q_{j-1}} - k_b T \qquad \text{for} \; j > 1.
\end{align*}

Note that the $3N$ momentum components in Eq.~\ref{eq:nhc_p}, the $4N$ components in Eq.~\ref{eq:nhc_pi}, and the thermostat momenta in Eq.~\ref{eq:nhc_p_eta} affect their own time-derivatives. Thus, the thermostatted system has a phase-space compressibility $\kappa = -7N \alpha_1 - \sum_j \alpha_{j+1}$. Resorting to Eq.~\ref{eq:nhc_eta} and the fact that $\alpha_{M+1} = 0$, the function $w(\vt x)$ that determines the invariant phase-space measure is given by
\begin{equation}
\label{eq:nhc_measure}
w = -7N \eta_1 - \sum_{j=2}^M \eta_j.
\end{equation}

Finally, analysis of the probability distribution generated by the canonical equations of motion can be carried out via the generalized phase-space analysis of Tuckerman \textit{et al}.\cite{Tuckerman2001} For this, conservation laws must be identified and driven variables must be eliminated. For a system without external forces, the extended energy $H$ and the vector quantity $e^{\eta_1}\sum_{i=1}^N {\vt p}_i = \vt K$ are integrals of motion, while the center-of-mass position can be considered as a driven variable.\cite{Tuckerman2001} Moreover, $2N$ equations must be eliminated from the system due to the constraints involving $\vt q_i$ and $\vt \pi_i$ for all $i$. In the general case, by taking all these facts into account and applying the analysis of Ref.~\onlinecite{Tuckerman2001}, we can deduce that the metric determinant factor of the effective phase space is $\sqrt{g} = e^{(6N-2) \eta_1 + \sum_{j=2}^M \eta_j}$ and that the correct canonical distribution is attained if one makes $L = 6N$. In the particular (and rather common) situation in which one sets $\vt P = \vt 0$ at the beginning of a simulation, one must make $L = 6N - 3$ because all three elements of $\vt P$ will be conserved.\cite{Martyna1994}

\subsection{Reversible, Measure-Preserving Integration of the Canonical Equations of Motion}

As in the Hamiltonian case, the evolution of a phase-space function $f(\vt r, \vt p, \vt q, \vt \pi, \vt \eta,{\vt p}_\eta)$ is given by the relation $f(t) = e^{t i\!L}f_0$, but now in the context of the generalized Liouville theorem.\cite{Tuckerman_1999, Tuckerman2001} Thus, we can employ the Trotter-Suzuki splitting to devise a time-reversible algorithm for integrating the equations of motion. In the microcanonical case, each separate term of the Liouville operator is Hamiltonian and, therefore, each factor of the splitting is a symplectic propagator. As a result, the whole propagator is symplectic and thus preserves the phase-space volume element. It is widely recognized that this property is important for numerical stability.\cite{Skeel1997} In the case of non-Hamiltonian systems, Ezra\cite{Ezra2006} introduced a systematic method for deriving accurate integrators which are not only time-reversible, but also preserve the phase-space measure associated with the original equations of motion. In short, a factorization scheme will preserve a given measure $e^{-w(\vt x)}d\vt x$ if each individual propagator preserves the same measure. As the author has shown,\cite{Ezra2006} for a particular splitting $i\!L = \sum_k i\!L^{(k)}$, measure preservation will take place if $\sum_j \tfrac{\partial}{\partial x_j} [e^{-w(\vt x)}\dot{x}_j^{(k)}] = 0$ for all $k$. Here, $\dot{\vt x}^{(k)}$ refers to the system of equations obtained from the individual operator $i\!L^{(k)}$, which might display its own compressibility $\kappa^{(k)} = \sum_j \partial \dot{x}_j^{(k)}/\partial x_j$. By means of the product rule, it is straightforward to devise an equivalent but more meaningful criterion, which is
\begin{equation}
\label{eq:split_kappa_w}
\kappa^{(k)} = i\!L^{(k)} w.
\end{equation}

Therefore, if the function $w(\vt x)$ that derives from Eq.~\ref{eq:relation_kappa_w} also satisfies Eq.~\ref{eq:split_kappa_w} for all $k$, then the corresponding factorization will preserve the measure $e^{-w(\vt x)}d\vt x$. Here, we propose and compare two distinct measure-preserving integrators for a rigid-body system coupled to a single thermostat chain. In the first one, the generalized Liouville operator is written as $i\!L = i\!L_\text{NVE} + i\!L_\text{NHC}$, where $i\!L_\text{NVE}$ is defined as in Eq.~\ref{eq:full_operator} and, as it follows from Eq.~\ref{eq:nhc_system},
\begin{equation}
\label{eq:iL_NHC}
\begin{split}
i\!L_\text{NHC} = &-\alpha_1 \sum_{i=1}^N \left( \tr{\vt p}_i \diff{}{\vt p_i} + \tr{\vt \pi}_i \diff{}{\vt \pi_i}\right) + \\
&+ \sum_{j=1}^{M} \left[\alpha_j \diff{}{\eta_j} + (G_j - \alpha_{j+1} p_{\eta_j}) \diff{}{p_{\eta_j}}\right].
\end{split}
\end{equation}

Then, by retaining the NVE factorization presented in Eq.~\ref{eq:trotter_splitting_NVE}, we write the full exponential operator for each time step as
\begin{equation}
\label{eq:trotter_splitting_NHC}
e^{\Delta t i\!L} = e^{\frac{\Delta t}{2} i\!L_\text{NHC}} e^{\frac{\Delta t}{2} i\!L_b} e^{\Delta t i\!L_r} e^{\Delta t i\!L_t}  e^{\frac{\Delta t}{2} i\!L_b} e^{\frac{\Delta t}{2} i\!L_\text{NHC}}.
\end{equation}

The Nos\'e-Hoover chain propagator is further split by making $i\!L_\text{NHC} = \sum_{j=0}^M i\!L_\text{NHC}^{(j)}$ and, afterwards,
\[
e^{\frac{\Delta t}{2} i\!L_\text{NHC}} = \Pi_{j=1}^n \Bigg[ \prod_{j=M}^1 e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg] e^{\frac{\Delta t}{2} i\!L_\text{NHC}^{(0)} } \Bigg[ \prod_{j=1}^M e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg].
\]

The boost, translation, and rotation propagators already satisfy the criterion in Eq.~\ref{eq:split_kappa_w} with the function $w$ expressed in Eq.~\ref{eq:nhc_measure} (they are all incompressible and keep $w$ unchanged). The NHC propagator is further split into factors that also satisfy Eq.~\ref{eq:split_kappa_w}.




In order to satisfy the criterion in Eq.~\ref{eq:split_kappa_w} for all factors, given the function $w$ expressed in Eq.~\ref{eq:nhc_measure}, we further split the NHC contribution as $i\!L_\text{NHC} = \sum_{j=0}^M i\!L_\text{NHC}^{(j)}$, where
\begin{subequations}
\begin{align}
i\!L_\text{NHC}^{(0)} &= -\alpha_1 \sum_{i=1}^N \left( \tr{\vt p}_i \diff{}{\vt p_i} + \tr{\vt \pi}_i \diff{}{\vt \pi_i}\right) + \alpha_1 \diff{}{\eta_1}, \\
i\!L_\text{NHC}^{(j)} &= (G_j - \alpha_{j+1} p_{\eta_j}) \diff{}{p_{\eta_j}} + \alpha_{j+1} \diff{}{\eta_{j+1}}, \label{eq:iL_NHC_j} \\
i\!L_\text{NHC}^{(M)} &= G_M \diff{}{p_{\eta_M}},
\end{align}
\end{subequations}
with $j$ varying from $1$ to $M-1$ in Eq.~\ref{eq:iL_NHC_j}. Then, each propagator $e^{\frac{\Delta t}{2} i\!L_\text{NHC}}$ present in Eq.~\ref{eq:iL_NHC} is factorized as
\[
e^{\frac{\Delta t}{2} i\!L_\text{NHC}} = \Bigg[ \prod_{j=M}^1 e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg] e^{\frac{\Delta t}{2} i\!L_\text{NHC}^{(0)} } \Bigg[ \prod_{j=1}^M e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg].
\]

The action of the propagator $e^{t i\!L_\text{NHC}^{(0)}}$ is the solution of the equations $\dot{\vt p}_i = -\alpha_1 \vt p_i$ and $\dot{\vt \pi}_i = -\alpha_1 \vt \pi_i$ for all $i \in [1,N]$ and $\dot{\eta}_1 = \alpha_1$, with all other variables remaining constant at their initial values. This system can be solved analytically, which results in
\begin{align*}
&\vt p_i(t) = \vt p_i^0 e^{-\alpha_1 t} \\
&\vt \pi_i(t) = \vt \pi_i^0 e^{-\alpha_1 t} \\
&\eta_1(t) = \eta_1^0 + \alpha_1 t
\end{align*}

In turn, the propagator $e^{t i\!L_\text{NHC}^{(j)}}$ defined in Eq.~\ref{eq:iL_NHC_j} behaves according to the equations $\dot{p}_{\eta_j} = G_j - \alpha_{j+1} p_{\eta_j}$ and $\dot{\eta}_{j+1} = \alpha_{j+1}$, with all variables other than $p_{\eta_j}$ and $\eta_{j+1}$ kept unchanged, whose analytical solution is
\begin{align*}
&p_{\eta_j}(t) = p_{\eta_j}^0 + \Big( G_j - \alpha_{j+1} p_{\eta_j}^0 \Big) \phi\left(\alpha_{j+1} t\right) t \\
&\eta_{j+1}(t) = \eta_{j+1}^0 + \alpha_{j+1} t
\end{align*}
where $\phi(x) = (1-e^{-x})/x$. We might note that, in order to avoid numerical issues with $x \rightarrow 0$, we evaluate $\phi(x)$ as $\sum_{n=0}^3 {(-1)^n x^n}/{(n+1)!}$ whenever $|x| \leq 10^{-4}$. The solution above is equivalent to that found in Ref.~\onlinecite{Martyna1996}.

Finally, the propagator $e^{t i\!L_\text{NHC}^{(M)}}$ involves a unique differential equation $\dot{p}_{\eta_M} = G_M$, whose solution is
\[
p_{\eta_M}(t) = p_{\eta_M}^0 + G_M t.
\]

------------

The second splitting scheme we propose here relies on the definition of the operator
\begin{align*}
i\!L_b^\ast &= \sum_{i=1}^N \left( \tr{\vt F}_i - \alpha_1 \tr{\vt p}_i \right) \diff{}{\vt p_i} \\
&+ \sum_{i=1}^N \left(2 \tr{\vt \tau}_i \tr{\mt C}_i - \alpha_1 \tr{\vt \pi}_i \right) \diff{}{\vt \pi_i} + \alpha_1 \diff{}{\eta_1}.
\end{align*}



It is worth noting that an analytical solution can also be derived for the system of equations $\dot{\vt p}_i = {\vt F}_i - \alpha_1 \vt p_i$ and $\dot{\vt \pi}_i = 2 \mt C_i \vt \tau_i - \alpha_1 \vt \pi_i$ for all $i \in [1,N]$ if all other variables are constant. These equations are equivalent in form to the one solved above, so that their solutions are
\begin{align*}
&{\vt p}_i(t) = {\vt p}_i^0 + \left({\vt F}_i - \alpha_1 {\vt p}_i^0 \right) \phi\left(\alpha_1 t \right) t \\
&{\vt \pi}_i(t) = {\vt \pi}_i^0 + \left(2 {\mt C}_i{\vt \tau}_i - \alpha_1 {\vt \pi}_i^0 \right) \phi\left(\alpha_1 t \right) t \\
&\eta_1(t) = \eta_1^0 + \alpha_1 t
\end{align*}


\begin{subequations}
\label{eq:solution_momenta}
\begin{align}
&{\vt p}_i(t) = {\vt p}_i^0 + \left({\vt F}_i - \alpha_1 {\vt p}_i^0 \right) \phi\left(\alpha_1 t \right) t \quad \text{and} \label{eq:solution_p} \\
&{\vt \pi}_i(t) = {\vt \pi}_i^0 + \left(2 {\mt C}_i{\vt \tau}_i - \alpha_1 {\vt \pi}_i^0 \right) \phi\left(\alpha_1 t \right) t. \label{eq:solution_pi}
\end{align}
\end{subequations}

By evaluating these functions simultaneously for all $i$, we accomplish the effect of a propagator $e^{t i\!L_b^\ast}$, where $i\!L_b^\ast$ is the Liouville operator given by
\[
i\!L_b^\ast = \sum_{i=1}^N \left[ \left( \tr{\vt F}_i - \alpha_1 \tr{\vt p}_i \right) \diff{}{\vt p_i} + \left(2 \tr{\vt \tau}_i \tr{\mt C}_i - \alpha_1 \tr{\vt \pi}_i \right) \diff{}{\vt \pi_i} \right].
\]

This is a kind of boost that already incorporates the influence of the thermostat chain. One of the aims of this paper is to compare the performance of the integrator given by Eq.~\ref{eq:trotter_splitting_NHC} to that obtained when the solution in Eq.~\ref{eq:solution_momenta} is considered. For that, we also define a modified Nos\'e-Hoover chain propagator $e^{i\!L^\ast_\text{NHC}}$, as follows:
\begin{equation}
\begin{split}
e^{\frac{\Delta t}{2} i\!L_\text{NHC}^\ast } = &\prod_{j=M}^1 \exp\left[\frac{\Delta t}{4} \left( G_j - \alpha_{j+1} p_{\eta_j} \right) \diff{}{p_{\eta_j}}\right] \\
\times &\exp\left(-\frac{\Delta t}{2} \sum_{j=1}^M \alpha_j \diff{}{\eta_j}\right) \\
\times &\prod_{j=1}^M \exp\left[\frac{\Delta t}{4} \left( G_j - \alpha_{j+1} p_{\eta_j} \right) \diff{}{p_{\eta_j}}\right]
\end{split}
\end{equation}

In the new propagator, $e^{\frac{\Delta t}{2} i\!L_\text{NHC}^{(0)} }$ is removed:
\[
e^{\frac{\Delta t}{2} i\!L_\text{NHC}^\ast} = \Bigg[ \prod_{j=M}^2 e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg] e^{\frac{\Delta t}{2} i\!L_\text{NHC}^{(1)} } \Bigg[ \prod_{j=2}^M e^{\frac{\Delta t}{4} i\!L_\text{NHC}^{(j)} } \Bigg].
\]

---------
We remark that the integration scheme proposed by Kamberaj \text{et al}.\cite{Kamberaj2005} does not fulfill this criterion. 

Of course, Eqs.~\ref{eq:solution_eta} and \ref{eq:solution_p_eta} are the ones used to evaluate the propagators above. Finally, the complete scheme is
\begin{equation}
\label{eq:modified_splitting}
\begin{split}
e^{\Delta t i\!L} = e^{\frac{\Delta t}{2} i\!L_\text{NHC}^\ast} e^{\frac{\Delta t}{2} i\!L_b^\ast} e^{\Delta t i\!L_r} e^{\Delta t i\!L_t}  e^{\frac{\Delta t}{2} i\!L_b^\ast} e^{\frac{\Delta t}{2} i\!L_\text{NHC}^\ast}.
\end{split}
\end{equation}

 Nevertheless, as will be shown in the forthcoming section, those numerical schemes successfully achieve the specified temperature and an acceptable long-term conservation of the extended energy $H$. Note that the term that premultiplies the extended phase-space volume in the invariant-measure above is a function of $\vt \eta$. Given that the time evolution of the physical variables and the thermostat momenta does not depend on $\vt \eta$, we might conclude that, in this case, the measure-preserving condition for every individual operator can actually be relaxed.

\subsection{Pressure of a System of Rigid Bodies}
\label{sec:pressure}

The pressure of a system with constant NVT, for which $\sum_{i=1}^N{\vt F}_i = 0$, is calculated by\cite{Louwerse2006, Tuckerman2001}
\[
P = \frac{(N-1) k_B T + \left\langle W \right\rangle}{V},
\]
where $W$ is the internal virial of the system, defined as $W = - V \frac{dU}{dV}$. For simplicity, we consider a system of rigid bodies under periodic boundary conditions whose potential energy function is pairwise additive with respect to individual atoms, so that the approach of Louwerse and Baerends\cite{Louwerse2006} can be applied (otherwise, one can employ the approach of Thompson \textit{et al.}\cite{Thompson2009}). Due to the rigidity of the bodies, interactions amongst companion atoms (i.e., atoms belonging to the same body) are irrelevant. Assuming that the minimum image convention\cite{Allen1989} applies for entire bodies, meaning that the simulation box is large enough to preclude any atom from having their own images or images of its companion atoms within its cutoff radius, the potential energy per unit box is given by
\begin{equation}
\label{eq:U_pairwise_pbc}
U({\vt r}, {\vt q}) = \sum_{i=1}^{N-1} \sum_{j=i+1}^N \sum_{k=1}^{{n_p}_i} \sum_{l=1}^{{n_p}_j} \upsilon(r_{ijkl}),
\end{equation}
where $\upsilon(r)$ is a pair interaction potential and $r_{ijkl}$ is the distance between the $k$-th atom of body $i$ to its nearest image of the $l$-th atom of body $j$. Such distance is the norm of a vector ${\vt r}_{ijkl} = \hat{\vt r}_{ij} + \tr{[{\mt A}({\vt q}_i)]}{{\vt d}_k}_i - \tr{[{\mt A}({\vt q}_j)]}{{\vt d}_l}_k$, where $\hat{\vt r}_{ij}$ is the minimum-image vector pointing from the center of mass of body $j$ to that of body $i$. We note that $U$ does not depend explicitly on $V$, which makes ${\partial U}/{\partial V} = 0$. If the atoms were free to move individually, an isotropic change in volume would displace all atoms and we would have ${\partial {\vt r}_{ijkl}}/{\partial V} = (3V)^{-1} \tr{\vt r}_{ijkl}$.\cite{Louwerse2006} In this event, the atomic internal virial would be computed by
\begin{equation}
\label{eq:virial_atoms}
W_\text{a} = \frac{1}{3} \sum_{i=1}^{N-1} \sum_{j=i+1}^N \sum_{k=1}^{{n_p}_i} \sum_{l=1}^{{n_p}_j} \tr{\vt r}_{ijkl} {\vt f}_{ijkl},
\end{equation}
where $\vt f_{ijkl} = -{\partial \upsilon}/{\partial \vt r_{ijkl}}$ is the minimum-image force exerted by the $l$-th atom of body $j$ on the $k$-th atom of body $i$. In the case of rigid bodies, considering that an isotropic change in volume would neither deform nor rotate them, but only promote center-of-mass displacements, we have that ${\partial \hat{\vt r}_{ij}}/{\partial V} = (3V)^{-1} \tr{\hat{\vt r}}_{ij}$ and ${\partial {\vt q}_i}/{\partial V} = {\partial {\vt q}_j}/{\partial V} = \tr{\vt 0}$. Therefore, by applying the chain rule to Eq.~\ref{eq:U_pairwise_pbc} and realizing that $\partial \vt r_{ijkl}/\partial \hat{\vt r}_{ij} = \vt 1_3$, we obtain
\[
\label{eq:dUdV_rigid_bodies}
\frac{dU}{dV} = -\frac{1}{3V} \sum_{i=1}^{N-1} \sum_{j=i+1}^N \sum_{k=1}^{{n_p}_i} \sum_{l=1}^{{n_p}_j} \tr{\hat{\vt r}}_{ij} \vt f_{ijkl}.
\]

There are two convenient ways of employing this result to compute the internal virial of a system of rigid bodies. On one hand, we can explore the fact that ${\hat{\vt r}}_{ij}$ does not depend on the indexes $k$ and $l$. On the other hand, we can replace $\hat{\vt r}_{ij} = {\vt r}_{ijkl} - {{\vt \delta}_k}_i + {{\vt \delta}_l}_k$ and make use of the fact that $\vt f_{ijkl} = -\vt f_{jilk}$. Finally, we have
\begin{subequations}
	\label{eq:virial_rigid_bodies}
	\begin{align}
	W &= \frac{1}{3} \sum_{i=1}^{N-1} \sum_{j=i+1}^N \tr{\hat{\vt r}}_{ij} \vt F_{ij} \\
	  &= W_\text{a} - \frac{1}{3} \sum_{i=1}^N \sum_{k=1}^{{n_p}_i} {\tr{\vt \delta}_k}_i {{\vt f}_k}_i,
	\end{align}
\end{subequations}
where $W_\text{a}$ is the atomic virial given by Eq.~\ref{eq:virial_atoms}, while $\vt F_{ij}$ is the total action of body $j$ (and its images) over body $i$ and $\vt f_{ik}$ is the resultant force exerted on the $k$-th atom of body $i$, respectively given by
\
\[
\vt F_{ij} = \sum_{k=1}^{{n_p}_i} \sum_{l=1}^{{n_p}_j} \vt f_{ijkl} \quad \text{and} \quad \vt f_{ik} = \sum_{\substack{j=1\\j \neq i}}^N \sum_{l=1}^{{n_p}_j} \vt f_{ijkl}.
\]

\section{Numerical Results}
\label{sec:numerical_results}

In this section, we analyze some performance aspects of the integration schemes when applied to a molecular system in the liquid state. For this, we simulated a system containing 356 TIP3P water molecules\cite{Price2004} at a density of 999.56 $kg/m^3$. The intermolecular interactions were truncated at 9 \AA. The shifted-force (SF) method\cite{Allen1989, Fennell2006, Toxvaerd_2011} was used to treat both the Coulombic and the 12-6 Lennard-Jones (LJ) interactions.

\subsection{Numerical Stability}
\label{sec:performance}

In order to evaluate the stability of the numerical integrators, we employ a measure given by\cite{Tuckerman2010}
\begin{equation}
\label{eq:performance}
D\!E =  \frac{1}{\mathcal N} \sum_{t=1}^{\mathcal N} \left| \frac{E_t - E_0}{E_0} \right|,
\end{equation}
from which it is possible to quantify the average deviation of the supposedly conserved quantity $E$ (either $\mathcal{H}$ of Eq.~\ref{eq:H_NVE} or $H$ of Eq.~\ref{eq:H_nvt}) from its initial value $E_0$ after a certain number of time steps $\mathcal N$. Both the instantaneous fluctuations, given by the term inside the summation, and the long-time conservation of energy, $D\!E$, are monitored.

Recall that, when the splitting scheme of Eq.~\ref{eq:splitting_rot} is executed with $\delta t_j = \Delta t/n$ for all $j$, the method introduced here for the NVE dynamics is just a mathematical reformulation of the algorithm of Miller \textit{et al}.\cite{Miller2002} Therefore, short trajectories obtained with both methods should coincide up to round-off errors. In Fig.~\ref{fig:miller1fs}, we plot the instantaneous fluctuations of total energy obtained with $n = 1$ and a time step of 1~fs using both methods. The simulation with the algorithm of Ref.~\onlinecite{Miller2002} was performed using the LAMMPS software package.\cite{Plimpton1995} For the purpose of comparison, we did not carry out force shifting for the Lennard-Jones model, as this is not implemented in LAMMPS. It can be seen in Fig.~\ref{fig:miller1fs} that, in fact, the fluctuations of both methods are of similar magnitudes.

\begin{figure}
	\includegraphics{millerourmd}
	\caption{Instantaneos fluctuations of energy for liquid water using Eq.~\ref{eq:trotter_splitting_NVE} (solid line) and the LAMMPS implementation of the algorithm of Ref.~\onlinecite{Miller2002} (dotted line) with $n = 1$, $\Delta t = 1$ fs, and $E_0 = -2799.87$ kcal/mol.}
	\label{fig:miller1fs}
\end{figure}

In Table~\ref{table:nve}, we compare the energy drifts observed when the rotational operator in Eq.~\ref{eq:splitting_rot} is split using either $n = 1$ or the sixth-order Yoshida-Suzuki factorization scheme ($n = 7$). As observed, for a small time steps of 1~fs, increasing the order of factorization does not provide any improvement. As the time step size increases, trajectories with higher accuracy are achieved with $n = 7$. Nevertheless, the improvement is only marginal and all trajectories are stable, exhibiting a small long-time energy drift. Thus, we proceed by considering $n = 1$ in the analysis of the NVT dynamics.

\begin{table}
	\caption{Average total-energy deviations for liquid water in NVE simulations for Eq.~\ref{eq:splitting_rot} with either $n = 1$ or $n = 7$ with Yoshida-Suzuki factorization.}
	\label{table:nve}
	\begin{ruledtabular}
		\begin{tabular}{ccc}
			 & \multicolumn{2}{c}{ $D\!E$ } \\
			 \cline{2-3}
			 $\Delta t$/fs & $n = 1$ & $n = 7$ \\
			 \hline
			 1.0 & 0.000055 & 0.000074 \\
			 2.0 & 0.00048  & 0.00031  \\
			 3.0 & 0.0012   & 0.0011   \\
		\end{tabular}
	\end{ruledtabular}
\end{table}

It is not the purpose of this work to propose an optimal factorization scheme for the NVT dynamics, but rather to show that a unique thermostat chain is capable of maintaining the average temperature at its specified value while providing the proper sampling of the canonical ensemble. \textbf{In order to use a constant value for the smaller time step in the NHC and NHC* operators $(\Delta t/4)$, we factorized those operators analogously to the scheme given by Eq.~\ref{eq:splitting_rot}}. Recalling that in the NVT dynamics the conserved quantity is the extended energy $H$, in Table~\ref{table:denvt} we show the results of Eq.~\ref{eq:performance} as well as the average temperatures obtained in each case. It can be seen that both integrators, represented by the Eq.~\ref{eq:trotter_splitting_NHC} and Eq.~\ref{eq:modified_splitting}, systematically achieve the specified temperature, regardless of the time step size. In addition, the energy drift is, at its worst, around $1 \%$.

\begin{table}
	\begin{threeparttable}
		\caption{Average deviation of the conserved quantity ($DE$) and average temperatures from liquid water simulation with NVT integration \tnote{a}\tnote{b}}
		\label{table:denvt}
		\begin{ruledtabular}
			\begin{tabular}{ccccc}
				& \multicolumn{2}{c}{Eq.~\ref{eq:trotter_splitting_NHC}} & \multicolumn{2}{c}{Eq.~\ref{eq:modified_splitting}} \\
				\cline{2-5}
				$\Delta t$/fs & $D\!E$ & $T$/K & $D\!E$ & $T$/K \\
				\hline
				1.0 & 0.000043 & 298.16  & 0.000052  & 298.15 \\
				2.0 & 0.00013  & 298.23  & 0.00017   & 298.06 \\
				3.0 & 0.00089  & 298.17  & 0.0013    & 298.12
			\end{tabular}
		\end{ruledtabular}
		\begin{tablenotes}
			\item[a] The standard deviation of the mean temperature for all cases is $\sigma = 0.037$.
			\item[b] The smaller time step in the NHC and NHC* operators is 0.25 fs.
		\end{tablenotes}
	\end{threeparttable}
\end{table}

\subsection{New Results}

\begin{table*}
\caption{Results.....}
\label{table:NVE}
\begin{ruledtabular}
\begin{tabular}{cccccccc}
$\Delta t$ (fs) & $T$ (K) & $\langle U\rangle$ (kcal/mol) & $\langle K\rangle$ (kcal/mol) & $\langle K_t\rangle$ (kcal/mol) & $\langle K_r\rangle$ (kcal/mol) & P (atm) & $R$ (kcal/mol.ns) \\
\hline
1.0 & $305.95\pm0.03$ & $-8395.4\pm0.1$ & $1646.1\pm0.1$ & $823.3\pm0.1$ & $822.9\pm0.1$ & $151\pm2$ & $0.0471$ \\
2.0 & $305.17\pm0.03$ & $-8389.0\pm0.1$ & $1641.9\pm0.1$ & $823.2\pm0.1$ & $818.8\pm0.1$ & $148\pm2$ & $0.853$ \\
3.0 & $304.34\pm0.03$ & $-8374\pm2$ & $1637.5\pm0.2$ & $824.0\pm0.1$ & $813.4\pm0.1$ & $152\pm2$ & $3.96$ \\
4.0 & $303.6\pm0.4$ & $-8349\pm5$ & $1633\pm2$ & $826.8\pm0.2$ & $806.5\pm0.4$ & $168\pm2$ & $8.25$ \\
\end{tabular}
\end{ruledtabular}
\end{table*}



\begin{table*}
\caption{Results.....}
\label{table:proposed_method}
\begin{ruledtabular}
\begin{tabular}{cccccccc}
$\Delta t$ (fs) & $T$ (K) & $\langle U\rangle$ (kcal/mol) & $\langle K\rangle$ (kcal/mol) & $\langle K_t\rangle$ (kcal/mol) & $\langle K_r\rangle$ (kcal/mol) & P (atm) & $R$ (kcal/mol.ns) \\

\hline
\multicolumn{8}{c}{Proposed Method} \\
1.0 & $300.01\pm0.02$ & $-8465.1\pm0.5$ & $1614.2\pm0.1$ & $807.4\pm0.1$ & $806.8\pm0.1$ & $62\pm2$ & $0.0328$ \\
2.0 & $300.01\pm0.03$ & $-8450.8\pm0.4$ & $1614.2\pm0.2$ & $809.4\pm0.1$ & $804.7\pm0.1$ & $73\pm2$ & $0.597$ \\
3.0 & $299.97\pm0.04$ & $-8425.7\pm0.5$ & $1614.0\pm0.2$ & $812.8\pm0.1$ & $801.2\pm0.2$ & $90\pm2$ & $3.44$ \\
4.0 & $299.93\pm0.04$ & $-8391.4\pm0.6$ & $1613.7\pm0.2$ & $817.1\pm0.2$ & $796.6\pm0.2$ & $119\pm2$ & $5.64$ \\

\hline
\multicolumn{8}{c}{Alternative Method} \\
1.0 & $300.00\pm0.02$ & $-8465.5\pm0.5$ & $1614.1\pm0.1$ & $807.1\pm0.1$ & $807.0\pm0.1$ & $65\pm2$ & $0.108$ \\
2.0 & $299.99\pm0.03$ & $-8450.5\pm0.5$ & $1614.1\pm0.2$ & $809.3\pm0.1$ & $804.7\pm0.1$ & $72\pm2$ & $1.31$ \\
3.0 & $299.98\pm0.04$ & $-8425.9\pm0.5$ & $1614.0\pm0.2$ & $812.5\pm0.1$ & $801.5\pm0.2$ & $88\pm2$ & $2.53$ \\
4.0 & $300.01\pm0.04$ & $-8390.4\pm0.6$ & $1614.2\pm0.2$ & $817.4\pm0.2$ & $796.8\pm0.2$ & $120\pm2$ & $7.31$ \\

\hline
\multicolumn{8}{c}{Method of Kamberaj \textit{et al}.\cite{Kamberaj2005}} \\
1.0 & $299.53\pm0.02$ & $-8470.9\pm0.5$ & $1611.6\pm0.1$ & $806.4\pm0.1$ & $805.2\pm0.1$ & $52\pm2$ & $0.023$ \\
2.0 & $298.24\pm0.03$ & $-8471.2\pm0.5$ & $1604.6\pm0.2$ & $805.4\pm0.1$ & $799.2\pm0.1$ & $47\pm2$ & $17.0$ \\
3.0 & $295.94\pm0.04$ & $-8480.9\pm0.6$ & $1592.3\pm0.2$ & $804.2\pm0.1$ & $788.1\pm0.1$ & $28\pm2$ & $53.2$ \\
4.0 & $292.72\pm0.04$ & $-8494.7\pm0.7$ & $1575.0\pm0.2$ & $802.4\pm0.1$ & $772.5\pm0.2$ & $-1\pm2$ & $60.6$ \\

\hline
\multicolumn{8}{c}{Double-Thermostat Analogue of the Proposed Method} \\
1.0 & $300.00\pm0.02$ & $-8466.0\pm0.5$ & $1614.1\pm0.1$ & $806.6\pm0.1$ & $807.5\pm0.1$ & $60\pm2$ & $6.42$\\
2.0 & $299.98\pm0.03$ & $-8452.0\pm0.5$ & $1614.0\pm0.2$ & $807.1\pm0.1$ & $806.9\pm0.1$ & $71\pm2$ & $80.4$ \\
3.0 & $300.16\pm0.04$ & $-8426.1\pm0.5$ & $1615.0\pm0.2$ & $808.4\pm0.1$ & $806.6\pm0.1$ & $90\pm2$ & $1.38\times10^4$ \\
4.0 & $300.75\pm0.04$ & $-8385.3\pm0.6$ & $1618.2\pm0.2$ & $811.6\pm0.1$ & $806.6\pm0.2$ & $125\pm2$ & $4.29\times10^4$ \\

\hline
\multicolumn{8}{c}{Double-Thermostat Analogue of the Alternative Method} \\
1.0 & $299.98\pm0.02$ & $-8465.6\pm0.5$ & $1614.0\pm0.1$ & $806.6\pm0.1$ & $807.4\pm0.1$ & $56\pm2$ & $4.87$ \\
2.0 & $299.96\pm0.03$ & $-8452.0\pm0.5$ & $1613.9\pm0.2$ & $807.1\pm0.1$ & $806.8\pm0.1$ & $71\pm2$ & $85.1$ \\
3.0 & $300.20\pm0.04$ & $-8426.0\pm0.5$ & $1615.2\pm0.2$ & $808.5\pm0.1$ & $806.7\pm0.1$ & $89\pm2$ & $1.50\times10^4$ \\
4.0 & $300.75\pm0.04$ & $-8384.7\pm0.6$ & $1618.1\pm0.2$ & $811.6\pm0.1$ & $806.6\pm0.2$ & $123\pm2$ & $4.33\times10^4$ \\

\hline
\multicolumn{8}{c}{Single-Thermostat Analogue of the Method of Kamberaj \textit{et al}.\cite{Kamberaj2005}} \\
1.0 & $299.52\pm0.02$ & $-8470.2\pm0.5$ & $1611.6\pm0.1$ & $805.9\pm0.1$ & $805.6\pm0.1$ & $58\pm2$ & $0.272$ \\
2.0 & $298.18\pm0.03$ & $-8471.8\pm0.5$ & $1604.3\pm0.2$ & $804.4\pm0.1$ & $799.9\pm0.1$ & $44\pm2$ & $0.390$ \\
3.0 & $295.97\pm0.04$ & $-8474.6\pm0.5$ & $1592.4\pm0.2$ & $801.6\pm0.1$ & $790.8\pm0.2$ & $29\pm2$ & $3.00$ \\
4.0 & $292.65\pm0.04$ & $-8478.7\pm0.6$ & $1574.6\pm0.2$ & $797.6\pm0.2$ & $777.0\pm0.2$ & $10\pm2$ & $8.12$ \\

\end{tabular}
\end{ruledtabular}
\end{table*}


\begin{table}
	\caption{New results involving Kamberaj \text{et al}.\cite{Kamberaj2005}}
	\label{table:new_results}
	\begin{ruledtabular}
		\begin{tabular}{cccc}
			& \multicolumn{3}{c}{ Temperature (K) } \\
			\cline{2-4}
			$\Delta t$/fs & Proposed & Alternative & Kamberaj \text{et al}. \\
			\hline
			1.0 & $300.01 \pm 0.02$ & $300.00 \pm 0.02$ & $299.52 \pm 0.02$ \\
			2.0 & $300.01 \pm 0.03$ & $299.99 \pm 0.03$ & $298.24 \pm 0.03$ \\
			3.0 & $299.97 \pm 0.04$ & $299.98 \pm 0.04$ & $295.94 \pm 0.04$
		\end{tabular}
	\end{ruledtabular}
\end{table}

\begin{table}
	\caption{New results involving Kamberaj \text{et al}.\cite{Kamberaj2005}}
	\label{table:new_results_2}
	\begin{ruledtabular}
		\begin{tabular}{cccc}
			& \multicolumn{3}{c}{Drift rate [(kcal/mol)/ns]} \\
			\cline{2-4}
			$\Delta t$/fs & Proposed & Alternative & Kamberaj \text{et al}. \\
			\hline
			1.0 & $0.0328$ & $0.108$ & $0.023$ \\
			2.0 & $0.597$  & $1.31$  & $17.0$ \\
			3.0 & $3.44$   & $2.53$  & $53.2$
		\end{tabular}
	\end{ruledtabular}
\end{table}

\subsection{Partition of Energy}
\label{sec:energypartition}

Checking the consistency between the equipartition of energy and the simulated energies serves as another approach for investigating the precision of a simulation. In fact, as stated by Eastwood \textit{et al}.,\cite{Eastwood_2010} this kind of checking has been useful to improve methodologies related to the calculation of  electrostatic\cite{Levitt_1988, Guenot_1992, Arnold_1994} and dispersive\cite{Sagui_1999} interactions, as well as to detect errors in thermostats\cite{Harvey_1998, Mor_2008} and barostats.\cite{Feller_1995} The truncation error associated to the numerical schemes is a potential source of error, and is the focus of the work of Eastwood \textit{et al}.,\cite{Eastwood_2010} which investigates a solvated protein and a temperature difference of approximately 5.5~K is observed between the protein and the solvent using a time step of 2~fs.

In this paper, we analyze the partition of energy between the translational and rotational degrees of freedom, which are related to the temperature by the equipartition theorem as follows
\begin{subequations}
\begin{align}
\label{eq:tras_equipartition}
2 \langle E_\text{trans} \rangle = (3N - 3) k_b T
\end{align}
\begin{align}
\label{eq:rot_equipartition}
2 \langle E_\text{rot} \rangle = 3N k_b T
\end{align} 
\end{subequations}

In these equations, $N$ is the number of rigid bodies. In microcanonical MD simulations, conservation of total linear momentum $\boldsymbol{P}$ results in the loss of three translational degrees of freedom, which is the reason why the factor $3N-3$ appears in Eq.~\ref{eq:tras_equipartition}. For a cubic box with periodic boundary conditions, there is no rotational symmetry,\cite{Frenkel_2013, Kuzkin_2014} with which the total angular momentum is not conserved, giving a number of $3N$ rotational degrees of freedom. We calculate the average energy per DOF $\langle E_{cin} \rangle_{DOF} = \langle E_{cin} \rangle /N_{DOF}$ and then we calculate both the translational and rotational energies from equipartition as follows

\begin{equation}
\langle E_{kin}^{trans}\rangle =  \langle E_{kin} \rangle_{DOF} \, (3N-3)
\end{equation}

\begin{equation}
\langle E_{kin}^{rot} \rangle =  \langle E_{kin} \rangle_{DOF} \, (3N)
\end{equation}

In the tables below we report the translational and rotational energies using Eqs.~\ref{eq:tras_equipartition} and~\ref{eq:rot_equipartition}, together with those obtained in the NVE simulations. In this case, we simulated 903 molecules of liquid water in order to examine the behavior for a cutoff distance of $13$ {\AA}, which is a more conservative criterion as it provides better numerical stability. In Table~\ref{table:water_partition_LJ-SF} we observe that for a small time step of 0.5 fs the energies are in good correspondence, which is lost when the time step is increased. This result is confirmed also in Table~\ref{table:water_partition_13A_LJ-SF} for the cutoff distance of 13 {\AA}. This allows us to prove the influence of the truncation error on in this effect, in accordance with what Eastwood~\textit{et al.}~\cite{Eastwood_2010} point out. For significant deviations, the main implication is that Eqs.~\ref{eq:tras_equipartition} and~\ref{eq:rot_equipartition} are no longer suitable for the temperature calculation, which becomes an undefined property. In the aforementioned paper, the authors introduce an alternative approach for calculating the temperature which is based on the generalized equipartition theorem applied to the Shadow Hamiltonian, which will be investigated in future work.

\begin{table}
	\begin{threeparttable}
		\caption{Kinetic energy partition in NVE simulations of 903 water molecules with $r_c$ = 9~{\r A} and a shifted-force Lennard-Jones potential.\tnote{a}} %($5415 grados de libertad$)}
		\label{table:water_partition_LJ-SF}
		\begin{ruledtabular}
			\begin{tabular}{ccccccc}
				& & & \multicolumn{2}{c}{Equipartitioned} & \multicolumn{2}{c}{Simulated}\\
%				& & & \multicolumn{2}{c}{of energy} & \multicolumn{2}{c}{partition}\\
				\cline{4-7}
				$\Delta t$/fs & $T_\text{sim}$/K & $\langle E_\text{kin}\rangle$ & $\langle E_\text{trans}\rangle$ & $\langle E_\text{rot}\rangle$ & $\langle E_\text{trans}\rangle$ & $\langle E_\text{rot}\rangle$ \\
				\hline
				0.5 & 305.20  & 1642.11  & 820.60  & 821.06  & 820.60 & 821.51  \\
				1.0 & 304.92  & 1640.57  & 819.83  & 820.74  & 820.63 & 819.94  \\
				2.0 & 304.20  & 1636.74  & 817.92  & 818.82  & 820.56 & 816.18  \\
				3.0 & 302.97  & 1630.07  & 814.59  & 815.48  & 820.47 & 809.60
			\end{tabular}
		\end{ruledtabular}
		\begin{tablenotes}
			\item[a] Energies are in kcal/mol.
		\end{tablenotes}
	\end{threeparttable}
\end{table}

\begin{table}
	\begin{threeparttable}
		\caption{Kinetic energy partition in NVE simulations of 903 water molecules with $r_c$ = 13~{\r A} and a shifted-force Lennard-Jones potential.\tnote{a}} %($5415 grados de libertad$)}
		\label{table:water_partition_13A_LJ-SF}
		\begin{ruledtabular}
			\begin{tabular}{ccccccc}
				& & & \multicolumn{2}{c}{Equipartitioned} & \multicolumn{2}{c}{Simulated}\\
%				& & & \multicolumn{2}{c}{of energy} & \multicolumn{2}{c}{partition}\\
				\cline{4-7}
				$\Delta t$/fs & $T_\text{sim}$/K & $\langle E_\text{kin}\rangle$ & $\langle E_\text{trans}\rangle$ & $\langle E_\text{rot}\rangle$ & $\langle E_\text{trans}\rangle$ & $\langle E_\text{rot}\rangle$ \\
				\hline
				0.5 & 307.17 & 1652.71  & 825.90  & 826.81  & 825.96 & 826.75  \\
				1.0 & 306.98 & 1651.68  & 825.38  & 826.30  & 826.09 & 825.59  \\
				2.0 & 306.04 & 1646.60  & 822.85  & 823.75  & 825.57 & 821.03  \\
				3.0 & 304.79 & 1639.89  & 819.49  & 820.40  & 825.63 & 814.26
			\end{tabular}
		\end{ruledtabular}
		\begin{tablenotes}
			\item[a] Energies are in kcal/mol.
		\end{tablenotes}
	\end{threeparttable}
\end{table}

\subsection{Sampling Validation}
\label{sec:samplingvalidation}

In this subsection we present the results from a simple method that serves for checking the consistency between the sampled energy distributions and the theoretical ones. The procedure, introduced and implemented by Shirts ~\cite{Shirts2013}, relies on a quantitative statistical analysis of fitting and it is possible to perform linear and nonlinear fitting or a maximum likelihood approach too. This last approach does not involve any binning of the energies, hence no discretization error is present. We report the results corresponding to that method, and since it is instructive to have a graphical insight, we also show some figures of the linear fitting.

Recall that in the NVT ensemble the probability of observing an energy E is given by
\[
P(E/\beta) = Q(\beta)^{-1}\Omega(E)\exp\left(-\beta E\right),
\]
where $ \beta $ is the Boltzmann's constant, $ \Omega(E) $ is the density of states which does not depend on $ \beta $ , and $ Q(\beta) $  is the canonical partition function, linked to the Helmholtz Free Energy $ (A) $ by $A = -\beta^{-1}\ln(Q)$. 

Taking the ratio of the probability distributions at different temperatures, the unknown density of states cancels out and we get
\begin{equation}
\label{eq:probability_ratio}
\frac{P(E/\beta_2)}{P(E/\beta_1)} = \exp\left[(\beta_2 A_2 - \beta_1 A_1) - (\beta_2 - \beta_1)E\right].
\end{equation}
Taking the logarithm of Eq.~\ref{eq:probability_ratio}, we obtain
\begin{equation}
\label{eq:ln_probability_ratio}
\ln\frac{P(E/\beta_2)}{P(E/\beta_1)} = \left(\beta_2 A_2 - \beta_1 A_1\right) - \left(\beta_2 - \beta_1\right)E.
\end{equation}

The Eq.~\ref{eq:ln_probability_ratio} is the basis for the statistical analysis in the ensemble validation, which determines how many standard deviations the calculated slope is from the specified one,  $ \beta_2 - \beta_1 $. Note that it is independent of the unknown free energies. For a guidance on how to choose the temperature gap the reader is referred to the aforementioned paper. Given that the potential and kinetic energies are separable, the analysis can be made separately as follows

\begin{equation}
\label{eq:probability_ratio_pot}
\frac{P_{pot}(E/\beta_2)}{P_{pot}(E/\beta_1)} = \frac{Q_{pot}(\beta_1)}{Q_{pot}(\beta_2)}  \exp\left[(-\beta_2 - \beta_1)E_{pot}\right]
\end{equation}

\begin{equation}
\label{eq:probability_ratio_kin}
\frac{P_{kin}(E/\beta_2)}{P_{kin}(E/\beta_1)} = \frac{Q_{kin}(\beta_1)}{Q_{kin}(\beta_2)}  \exp\left[(-\beta_2 - \beta_1)E_{kin}\right]
\end{equation}
Furthermore,  it is possible to examine the consistency between the sampled kinetic energy and the corresponding Maxwell-Boltzmann distribution, which is given by the following expression:
\begin{equation}
\label{eq:mb}
P(E_{cin}) = \frac{\beta}{\sqrt{N_{DOF}\pi}} \exp\left[-\frac{\left(\beta E_{kin} - \frac{N_{DOF}}{2}\right)^2}{N_{DOF}} \right],
\end{equation}
where $N_{DOF}$ is the number of degrees of freedom. This last equations is a normal distribution characterized by an average of $ \langle E_{kin} \rangle = (N_{DOF}/2\beta) $ and variance $\sigma^2 = N_{DOF}/2\beta^2$, valid when equipartition of energy is satisfied.

In Fig.~\ref{fig:checkensemble} we show the result from the linear regression analysis for the potential energies sampled using Eq.~\ref{eq:trotter_splitting_NHC}. In figure legends we show the averages temperatures simulated. It can be seen that the mentioned algorithm generates a distribution consistent with the canonical ensemble, and that is also true for the kinetic energies. Likewise, in Fig.~\ref{fig:mbdistribution} we observe a good correspondence between the kinetic energy distribution at $T= 304.99 K$ and the corresponding Maxwell-Boltzmann distribution We arrive at the same conclusions for the approach given by Eq.~\ref{eq:modified_splitting}.

\begin{figure}
	\includegraphics{checkensemble}
	\caption{Linear plot of the log ratio probabilities with the true slope (solid line) and the measured slope from the linear regression analysis (symbols). Simulation of liquid water using Eq.~\ref{eq:trotter_splitting_NHC}, $\Delta t$ = 1~fs, $\bar{T}_1$ = 296.03~K, $\bar{T}_2$ = 304.99~K.}
	\label{fig:checkensemble}
\end{figure}

\begin{figure}
	\includegraphics{maxwell-botlzamm-paper}
	\caption{Probability distribution of the kinetic energy with sampled values and those calculated with Eq.~\ref{eq:mb}. Simulation of liquid water using Eq.~\ref{eq:trotter_splitting_NHC}, $\Delta t$ = 1~fs, $\bar{T}$ = 304.99~K.}
\label{fig:mbdistribution}
\end{figure}

Finally, in Table~\ref{table:ensemblevalidation} we present the results of the maximum likelihood approach applied for both NVT integration schemes. It can be seen that the deviations from the true slope, $\Delta T$ = 8.970~K, are less than $1\sigma$. This means that effectively, the sampled values do not deviate from the correct distribution to a statistically noticeable level.

\begin{table}
	\begin{threeparttable}
		\caption{Ensemble Validation of NVT algorithms for liquid water using the Maximum Likelihood Approach \tnote{a} \tnote{b}}
		\label{table:ensemblevalidation}
		\begin{ruledtabular}
			\begin{tabular}{ccccc}
				& \multicolumn{4}{c}{true $\Delta T$ = 8.970 K} \\
				\cline{2-5}
				& \multicolumn{2}{c}{potential} & \multicolumn{2}{c}{kinetic}\\
				\hline
				Method  &$\Delta T/K$ & $\sigma$ dev & $\Delta T/K$ & $\sigma$ dev \\
				\hline % inserts single-line 
				Eq.~\ref{eq:trotter_splitting_NHC} & 9.022 $\pm$ 0.117 & 0.57 & 8.928 $\pm$ 0.051 & 0.63 \\
				Eq.~\ref{eq:modified_splitting}    & 8.965 $\pm$ 0.101 & 0.05 & 8.967 $\pm$ 0.052 & 0.14
		\end{tabular}
		\end{ruledtabular}
		\begin{tablenotes}
			\item[a] The standard deviation of the mean temperature for all cases is $\sigma$ = 0.03.
			\item[b] $\bar{T}_1$ = 296.03~K and $\bar{T}_2$ = 304.99~K.
		\end{tablenotes}
	\end{threeparttable}
\end{table}

\subsection{Pressure Calculations}

In Fig.~\ref{fig:pressure} we compare the results using Eq.~\ref{eq:virial_rigid_bodies} with those from a simulation performed with LAMMPS, which uses a numerical estimation of the constraint forces in the pressure calculation. The simulations were run in the NVE ensemble, for which neither shifting to the LJ forces nor analytical tail corrections were considered.

Our purpose is....

As one can see in Fig.~\ref{fig:pressure}....

%\begin{center}
%  \label{fig:pressure}
%  \includegraphics{pressure2}
%  \captionof{figure}{Histograms of pressure obtained in this work (filled bars) and using LAMMPS %(unfilled bars). Simulation of liquid water with NVE integration. $\Delta t : 1 fs$  }
%\end{center}

\begin{figure}
	\includegraphics[width=0.5\textwidth,keepaspectratio]{FiguraAna}
	\caption{Histogram of pressure values obtained using Eq.~\ref{eq:virial_rigid_bodies} (filled bars), along with the results from a simulation using LAMMPS (unfilled bars). The average pressures are $\bar{P} = -0.60$~bar and $\bar{P} = 2.14$~bar, respectively. Simulation of liquid water with NVE integration, $\Delta t = 1$~fs, and $n = 1$.}
	\label{fig:pressure}
\end{figure}

\section{Concluding Remarks}
\label{sec:conclusion}

\begin{acknowledgments}
The authors acknowledge the financial support provided by Petrobras (project code CENPES 16113).
\end{acknowledgments}

\appendix

\section{Differentiation with vectors and matrices}
\label{sec:Diff_Rules}

Along the paper, we employ the gradient convention (rather than the Jacobian convention) for expressing derivatives with respect to vector variables. In this context, very often we differentiate a scalar function using one of the following rules:
\[
\diff{(\tr{\vt x}\vt a)}{\vt x} = \diff{(\tr{\vt a}\vt x)}{\vt x} = \vt a \quad \text{or} \quad \diff{(\tr{\vt x}\mt A \vt x)}{\vt x} = (\mt A + \tr{\mt A})\vt x,
\]
where $\vt a$ is a constant vector and $\mt A$ is a constant matrix. If $\mt A$ is symmetric, then $\mt A + \tr{\mt A} = 2\mt A$.

\section{Algebraic relations involving unit quaternions}
\label{sec:auxiliary_math}

We start by analyzing the matrix $\mt B$ as defined in Eq.~\ref{eq:def_B_and_C}. Note that $\tr{\mt B}\vt q = \vt 0$, where $\vt 0$ is a null vector.\cite{Haug1989, Shuster1993, Dichmann1999} This means that all columns of $\mt B$ are orthogonal to $\vt q$. As these columns have unit norm and are also orthogonal to each other, they form an orthonormal basis for the hyperplane orthogonal to $\mt q$, which is a subspace of $\mathbb{R}^4$. Therefore, the general operation $\vt y = \mt B \vt x$ transforms a vector $\vt x \in \mathbb{R}^3$ into a quaternion $\vt y \in \mathbb{R}^4$, but restricted to the mentioned hyperplane. Other two identities that hold for $\mt B$ are\citep{Haug1989}
\begin{equation}
\label{eq:basics_B}
\begin{aligned}
\tr{\mt B}\mt B &= (\tr{\vt q}{\vt q}) {\mt 1}_3 \text{ and} \\
\mt B\tr{\mt B} &= (\tr{\vt q}{\vt q}) {\mt 1}_4 - {\vt q}\tr{\vt q}.
\end{aligned}
\end{equation}

If $\tr{\vt q}{\vt q} = 1$, then the operation $\vt y = \mt B \vt x$ can always be reverted by $\tr{\mt B}$. This is not true for a general operation in the opposite direction, $\vt x = \tr{\mt B} \vt y$. Besides unit norm, it is necessary that $\tr{\vt q}\vt y = 0$ (i.e. orthogonality of $\vt y$ and $\vt q$) for the operation to be reversible by $\mt B$. In fact, the composite transformation $\mt B\tr{\mt B}$ corresponds to a projection into the hyperplane orthogonal to $\vt q$.\cite{Dichmann1999}

As the columns of $\mt B$ are permutations of the components of $\vt q$, one can write $\mt B = \begin{smallarray}{ccc} \hat{\mt B}_1{\vt q} & \hat{\mt B}_2{\vt q} & \hat{\mt B}_3{\vt q}\end{smallarray}$, where $\hat{\mt B}_1$, $\hat{\mt B}_2$, and $\hat{\mt B}_3$ are the following skew-symmetric permutation matrices:
\[
\hat{\mt B}_1 = \begin{smallarray}{cccc}
 0 & \text{-}1 &  0 &  0 \\
 1 &  0 &  0 &  0 \\
 0 &  0 &  0 &  1 \\
 0 &  0 & \text{-}1 &  0 \\
\end{smallarray} \quad
\hat{\mt B}_2 = \begin{smallarray}{cccc}
 0 &  0 & \text{-}1 &  0 \\
 0 &  0 &  0 & \text{-}1 \\
 1 &  0 &  0 &  0 \\
 0 &  1 &  0 &  0 \\
\end{smallarray} \quad
\hat{\mt B}_3 = \begin{smallarray}{cccc}
 0 &  0 &  0 & \text{-}1 \\
 0 &  0 &  1 &  0 \\
 0 & \text{-}1 &  0 &  0 \\
 1 &  0 &  0 &  0 \\
\end{smallarray}
\]

The product of $\mt B$ with an arbitrary vector $\vt x$ results in
\begin{equation}
\label{eq:product_B_vector}
\mt B \vt x = \begin{smallarray}{ccc} \hat{\mt B}_1 \vt q & \hat{\mt B}_2 \vt q & \hat{\mt B}_3 \vt q \end{smallarray} \begin{smallarray}{c} x_1 \\ x_2 \\ x_3 \end{smallarray} = \sum_{j=1}^3 x_j \hat{\mt B}_j \vt q.
\end{equation}

Similarly, the product of $\tr{\mt B}$ with an arbitrary quaternion $\vt \pi$ results in
\begin{equation}
\label{eq:vector_entries}
\tr{\mt B}\vt \pi =
\begin{smallarray}{c}
\tr{\vt q}\tr{\hat{\mt B}}_1 \\
\tr{\vt q}\tr{\hat{\mt B}}_2 \\
\tr{\vt q}\tr{\hat{\mt B}}_3 \\
\end{smallarray}\vt \pi = 
\begin{smallarray}{c}
\tr{\vt q}\tr{\hat{\mt B}}_1\vt \pi \\
\tr{\vt q}\tr{\hat{\mt B}}_2\vt \pi \\
\tr{\vt q}\tr{\hat{\mt B}}_3\vt \pi \\
\end{smallarray} = 
\begin{smallarray}{c}
\tr{\vt \pi}{\hat{\mt B}}_1\vt q \\
\tr{\vt \pi}{\hat{\mt B}}_2\vt q \\
\tr{\vt \pi}{\hat{\mt B}}_3\vt q \\
\end{smallarray}.
\end{equation}

With $\dot{\mt B} = \begin{smallarray}{ccc} \hat{\mt B}_1\dot{\vt q} & \hat{\mt B}_2\dot{\vt q} & \hat{\mt B}_3\dot{\vt q}\end{smallarray}$ being the time-derivative of matrix $\mt B$, we now focus on the product $\tr{\mt B}\dot{\mt B}$, whose each entry is $\{\tr{\mt B}\dot{\mt B}\}_{ij} = \tr{\vt q}\tr{\hat{\mt B}_i} \hat{\mt B}_j\dot{\vt q}$. By noting that products involving the permutation matrices satisfy the relations\cite{Dichmann1999}
\begin{equation}
\label{eq:BB_products}
\begin{aligned}
&\tr{\hat{\mt B}}_1 \hat{\mt B}_1 = \tr{\hat{\mt B}}_2 \hat{\mt B}_2 = \tr{\hat{\mt B}}_3 \hat{\mt B}_3 = \mt 1_4, \\
&\tr{\hat{\mt B}}_1 \hat{\mt B}_2 = -\tr{\hat{\mt B}}_2 \hat{\mt B}_1 = -\tr{\hat{\mt B}_3}, \\
&\tr{\hat{\mt B}}_2 \hat{\mt B}_3 = -\tr{\hat{\mt B}}_3 \hat{\mt B}_2 = -\tr{\hat{\mt B}_1}, \; \text{and} \\
&\tr{\hat{\mt B}}_3 \hat{\mt B}_1 = -\tr{\hat{\mt B}}_1 \hat{\mt B}_3 = -\tr{\hat{\mt B}_2}, \\
\end{aligned}
\end{equation}
and recalling that $\vt q$ and $\dot{\vt q}$ are mutually orthogonal (Eq.~\ref{eq:diff_qTq}), we can obtain a simplified expression for $\tr{\mt B}\dot{\mt B}$, which is
\begin{equation}
\label{eq:BtBdot}
\tr{\mt B}\dot{\mt B} = \begin{smallarray}{ccc}
0 & -\tr{\vt q} \tr{\hat{\mt B}_3}\dot{\vt q} &  \tr{\vt q} \tr{\hat{\mt B}_2}\dot{\vt q} \\
\tr{\vt q} \tr{\hat{\mt B}_3}\dot{\vt q} & 0 & -\tr{\vt q} \tr{\hat{\mt B}_1}\dot{\vt q} \\
-\tr{\vt q} \tr{\hat{\mt B}_2}\dot{\vt q} & \tr{\vt q} \tr{\hat{\mt B}_1}\dot{\vt q} & 0
\end{smallarray}.
\end{equation}

Skew-symmetric matrices like the one above are associated to cross products. For arbitrary vectors $\vt x$ and $\vt y$ in $\mathbb R^3$, it turns out that $\vt x \times \vt y = \mt S(\vt x)\vt y$, where $\mt S(\cdot)$ is an operator defined as
\begin{equation}
\label{eq:operator_S}
\mt S(\vt x) = \begin{smallarray}{ccc}
0   & -x_3 &  x_2 \\
x_3 &  0   & -x_1 \\
-x_2 &  x_1 &  0
\end{smallarray}.
\end{equation}

By contrasting the definition above with Eqs.~\ref{eq:vector_entries} and \ref{eq:BtBdot}, it becomes clear that
\begin{equation}
\label{eq:relation_B_qdot}
\tr{\mt B}\dot{\mt B} = {\mt S}\left( \tr{\mt B}\dot{\vt q} \right).
\end{equation}

We can also express $\mt C = \begin{smallarray}{ccc} \hat{\mt C}_1{\vt q} & \hat{\mt C}_2{\vt q} & \hat{\mt C}_3{\vt q}\end{smallarray}$, where $\hat{\mt C}_1$, $\hat{\mt C}_2$, and $\hat{\mt C}_3$ are the following skew-symmetric permutation matrices:
\[
\hat{\mt C}_1 = \begin{smallarray}{cccc}
 0 & \text{-}1 &  0 &  0 \\
 1 &  0 &  0 &  0 \\
 0 &  0 &  0 & \text{-}1 \\
 0 &  0 &  1 &  0 \\
\end{smallarray} \quad
\hat{\mt C}_2 = \begin{smallarray}{cccc}
 0 &  0 & \text{-}1 &  0 \\
 0 &  0 &  0 &  1 \\
 1 &  0 &  0 &  0 \\
 0 & \text{-}1 &  0 &  0 \\
\end{smallarray} \quad
\hat{\mt C}_3 = \begin{smallarray}{cccc}
 0 &  0 &  0 & \text{-}1 \\
 0 &  0 & \text{-}1 &  0 \\
 0 &  1 &  0 &  0 \\
 1 &  0 &  0 &  0 \\
\end{smallarray}
\]

Products involving these matrices are slightly different from those in Eq.~\ref{eq:BB_products}. They are
\begin{equation}
\label{eq:CC_products}
\begin{aligned}
&\tr{\hat{\mt C}}_1 \hat{\mt C}_1 = \tr{\hat{\mt C}}_2 \hat{\mt C}_2 = \tr{\hat{\mt C}}_3 \hat{\mt C}_3 = \mt 1_4, \\
&\tr{\hat{\mt C}}_1 \hat{\mt C}_2 = -\tr{\hat{\mt C}}_2 \hat{\mt C}_1 = \tr{\hat{\mt C}_3}, \\
&\tr{\hat{\mt C}}_2 \hat{\mt C}_3 = -\tr{\hat{\mt C}}_3 \hat{\mt C}_2 = \tr{\hat{\mt C}_1}, \; \text{and} \\
&\tr{\hat{\mt C}}_3 \hat{\mt C}_1 = -\tr{\hat{\mt C}}_1 \hat{\mt C}_3 = \tr{\hat{\mt C}_2}. \\
\end{aligned}
\end{equation}

A special connection between the permutation matrices that make $\mt B$ and $\mt C$ is the fact that $\tr{\hat{\mt B}_i}{\hat{\mt C}_j}$ is symmetric for any combination of $i$ and $j$. A direct consequence is that $\tr{\vt q}\tr{\hat{\mt B}}_i\hat{\mt C}_j\dot{\vt q} = \tr{\dot{\vt q}}\tr{\hat{\mt B}}_i\hat{\mt C}_j{\vt q}$, which means that $\tr{\mt B}\dot{\mt C} = \tr{\dot{\mt B}}{\mt C}$. Thus, differentiating Eq.~\ref{eq:factorization_of_A} with respect to time yields $\dot{\mt A} = \tr{\mt B}\dot{\mt C} + \tr{\dot{\mt B}}{\mt C} = 2 \tr{\dot{\mt B}}{\mt C}$. Note that Eq.~\ref{eq:basics_B} also applies for matrix $\mt C$, which means that, as far as $\tr{\vt q}\vt q = 1$, we can insert the product $\mt C\tr{\mt C}$ between $\tr{\mt B}$ and $\dot{\mt B}$ in Eq.~\ref{eq:relation_B_qdot} without altering its result. Then, using Eq.~\ref{eq:factorization_of_A} again and the conclusion above about $\dot{\mt A}$, we have that
\begin{equation}
\frac{1}{2} {\mt A}\tr{\dot{\mt A}} = {\mt S}\left( \tr{\mt B}\dot{\vt q} \right).
\end{equation}

As mentioned in Sec.~\ref{sec:kinematics}, ${\mt A}\tr{\dot{\mt A}} = \mt S(\vt \omega)$, which makes the equation above equivalent to Eq.~\ref{eq:relation_qdot_omega}.

\section{Potential energy differentiation}
\label{sec:Diff_PotEng}

Care must be taken when differentiating the potential energy with respect to $\vt q$ because the quaternion components are interdependent. According to Schay,\cite{Schay1995} when a vector variable $\vt x$ is subject to a constraint $g(\vt x) = 0$, the derivative of $f$ with respect to $\vt x$ must be computed by
\[
\diff{f}{\vt x} = (\vt 1 - \vt n \tr{\vt n})\left( \diff{f}{\vt x} \right)^\ast,
\]
where $\vt n$ is the unit vector proportional to $(\partial g/\partial \vt x)^\ast$, with the asterisk denoting a differentiation performed without considering the interdependence of the entries of $\vt x$. Note that transpositions are necessary when comparing the equation above, based on the gradient convention, with that in Ref.~\onlinecite{Schay1995}, where the Jacobian convention is used. In the case of a unit quaternion,
\[
g(\vt q) = \tr{\vt q}\vt q - 1 = 0 \; \rightarrow \; \left(\diff{g}{\vt q}\right)^\ast = 2 \vt q.
\]

Hence, the unit vector proportional to $(\partial g/\partial \vt x)^\ast$ is exactly $\vt q$. As the same constraint makes ${\mt C}\tr{\mt C} = \mt 1_4 - \vt q\tr{\vt q}$ (in analogy to Eq.~\ref{eq:basics_B}), the constrained derivative of $U$ can be represented by
\begin{equation}
\label{eq:diff_projection}
\diff{U}{\vt q} = {\mt C}\tr{\mt C} \left( \diff{U}{\vt q} \right)^\ast.
\end{equation}

Therefore, the constrained derivative is the projection of the unconstrained one in the hyperplane orthogonal to $\vt q$. Recently, Nielsen and Krenk\cite{Nielsen2012} employed a Lagrange multiplier approach to demonstrate the need of carrying out such a projection. Schay\cite{Schay1995, Schay1998} discussed on the equivalence of these two approaches.

By applying the chain rule, we have
\[
\left( \diff{U}{\vt q} \right)^\ast = \sum_{j=1}^{n_p} \left( \diff{\vt R_j}{\vt q} \right)^\ast \diff{U}{\vt R_j} = - \sum_{j=1}^{n_p} \left( \diff{\vt \delta_j}{\vt q} \right)^\ast {\vt F_j},
\]
where $\vt R_j = \vt r + \vt \delta_j$ and $\vt F_j = -\partial U/\partial \vt R_j$ is, by definition, the force applied on particle $j$. Temporarily dropping the particle index for simplicity, we recall from Sec.~\ref{sec:kinematics} that $\vt \delta = \tr{\mt A}\vt d$, where $\vt d$ is a constant vector. As each entry of $\mt A = \tr{\mt B}{\mt C}$ is $A_{ij}=\tr{\vt q} \tr{\hat{\mt B}}_i \hat{\mt C}_j {\vt q}$, an entry of $\vt \delta$ is given by
\[
\delta_j = \sum_{i=1}^{3} d_i \tr{\vt q} \tr{\hat{\mt C}}_j \hat{\mt B}_i {\vt q}.
\]

Due to the symmetry of $\tr{\hat{\mt C}}_j \hat{\mt B}_i$, an unconstrained differentiation results in
\[
\left(\diff{\delta_j}{\vt q}\right)^\ast = 2 \sum_{i=1}^{3} d_i \tr{\hat{\mt C}}_j \hat{\mt B}_i {\vt q} = -2{\hat{\mt C}}_j {\mt B}{\vt d},
\]
where we have factored out $\tr{\hat{\mt C}}_j = -\hat{\mt C}_j$ from the summation and then employed Eq.~\ref{eq:product_B_vector}. The constrained differential $\partial \vt \delta/\partial \vt q$ is, therefore,
\[
\diff{\vt \delta}{\vt q} = -2{\mt C}\tr{\mt C}
\begin{smallarray}{ccc}
{\hat{\mt C}}_1 {\mt B}{\vt d} & {\hat{\mt C}}_2 {\mt B}{\vt d} & {\hat{\mt C}}_3 {\mt B}{\vt d}
\end{smallarray} = 2{\mt C}\;{\mt S}\!\left(\tr{\mt C}{\mt B}\vt d\right),
\]
where we have carried out the second matrix product above, employed the properties presented in Eq.~\ref{eq:CC_products}, and then used the operator defined in Eq.~\ref{eq:operator_S}. Finally, after realizing that $\tr{\mt C}{\mt B}\vt d = \tr{\mt A}{\vt d} = \vt \delta$, we can use the result above to obtain
\[
\diff{U}{\vt q} = - 2 \mt C \sum_{j=1}^{n_p} \mt S(\vt \delta_j) {\vt F_j}  = - 2 \mt C \sum_{j=1}^{n_p} \vt \delta_j \times {\vt F_j}.
\]

Therefore, the constrained derivative of $U$ with respect to $\vt q$ is proportional to the quaternion-fixed representation of the resultant torque over the body.

\section{Derivation of the Euler equation and its solution for a torque-free rotation}
\label{sec:derivation_euler}

Recall that $\vt \pi$ is twice the quaternion-fixed version of the angular momentum vector. Thus, it is expected that Eq.~\ref{eq:EDO_pi} will result in the well-known Euler equation, which describes the evolution of the angular momentum in the body-fixed frame, if $\frac{1}{2} \tr{\mt B}$ is premultiplied to both sides. In order to show that this actually occurs, we start by carrying out the premultiplication to obtain
\[
\frac{1}{2} \tr{\mt B} \dot{\vt \pi} = \frac{1}{4} \tr{\mt B} \mt \Omega \vt \omega + \mt A \vt \tau.
\]

Once $\mt \Omega = \begin{smallarray}{ccc} \hat{\mt B}_1{\vt \pi} & \hat{\mt B}_2{\vt \pi} & \hat{\mt B}_3{\vt \pi}\end{smallarray}$, in analogy with Eq.~\ref{eq:BtBdot} we conclude that $\tr{\mt B} \mt \Omega = \mt S(\tr{\mt B}\vt \pi) = 2 \mt S(\mt I \vt \omega)$. In addition,
\[
\tr{\mt B} \dot{\vt \pi} = \frac{d(\tr{\mt B}\vt \pi)}{dt} - \tr{\dot{\mt B}}\vt \pi = 2 \mt I\dot{\vt \omega} - 2 \tr{\dot{\mt B}} \mt B \mt I \vt \omega,
\]
where we have inserted $\mt B \tr{\mt B}$ between $\tr{\dot{\mt B}}$ and $\vt \pi$ and substituted $\tr{\mt B} \vt \pi = 2 \mt I \vt \omega$. Finally, after transposing Eq.~\ref{eq:relation_B_qdot} with $\tr{\mt B}\dot{\vt q}$ replaced by $\frac{1}{2} \vt \omega$ and resorting to the relation between $\mt S(\cdot)$ and a cross product, we obtain
\[
\mt I \dot{\vt \omega} + \vt \omega \times (\mt I \vt \omega) = \mt A \vt \tau,
\]
which is exactly the Euler equation of motion for rigid bodies.\cite{Goldstein2002} Its main advantage, in comparison with Eq.~\ref{eq:EDO_pi}, is that it completely decouples from the quaternion $\vt q$ when $\vt \tau = \vt 0$. In such a torque-free situation, the vector equation can be rewritten as the following system:
\begin{align*}
I_1 \dot{\omega}_1 - (I_2 - I_3) \omega_2 \omega_3 = 0\\
I_2 \dot{\omega}_2 + (I_1 - I_3) \omega_1 \omega_3 = 0 \\
I_3 \dot{\omega}_3 - (I_1 - I_2) \omega_1 \omega_2 = 0
\end{align*}

Analytical solutions for this system are a textbook subject.\cite{Landau1976} Here we present the solution for the case under consideration, when $I_1 > I_2 > I_3$ (an asymmetrical top), in a form that aims to facilitate computer implementation, inspired by the forms presented in Refs.~\onlinecite{Landau1976} and \onlinecite{Thorn2012}. In a free rotation, the kinetic energy $K_r = \tfrac{1}{2} \tr{\vt \omega}{\mt I}{\vt \omega}$ and the space-frame angular momentum $\vt L = \tfrac{1}{2}\tr{\mt C}{\vt \pi} = \tr{\mt A}{\mt I}{\vt \omega}$ are integrals of motion. Note that the square norm of $\vt L$ does not depend explicitly on $\vt q$ in any frame of reference:
\[
L^2 = \tr{\vt L}{\vt L} = \tr{\vt \omega}{\mt I}^2{\vt \omega} = \frac{1}{4}\tr{\vt \pi}{\vt \pi}.
\]

Therefore, if we compute $K_r$ and $L^2$ from the initial angular velocity ${\vt \omega}^0 = \tr{[\omega_1^0 \; \omega_2^0 \; \omega_3^0]}$, we can apply the following constraints to the Euler equations:
\begin{align*}
I_1 \omega_1^2 + I_2 \omega_2^2 + I_3 \omega_3^2 = 2 K_r \\
I_1^2 \omega_1^2 + I_2^2 \omega_2^2 + I_3^2 \omega_3^2 = L^2
\end{align*}

By solving these equations for $\omega_1^2$ and $\omega_3^2$, we obtain
\begin{equation}
\label{eq:omegas_1_and_3}
\omega_1^2 = A_1^2 \left[1-\left(\frac{\omega_2}{\lambda_1}\right)^2\right] \;\; \text{and} \;\; \omega_3^2 = A_3^2 \left[1-\left(\frac{\omega_2}{\lambda_3}\right)^2\right],
\end{equation}
where
\begin{equation}
\lambda_1 = \sqrt{\frac{L^2 - 2 I_3 K_r}{I_2(I_2 - I_3)}} \;\; \text{and} \;\; \lambda_3 = \sqrt{\frac{2 I_1 K_r - L^2}{I_2(I_1 - I_2)}}.
\end{equation}

In order to obtain the prefactors $A_1$ and $A_3$ with the correct signs, we realize that Eqs.~\ref{eq:omegas_1_and_3} must be valid at the initial instant ($t = 0$), which makes
\begin{equation}
A_1 = \frac{\omega_1^0}{\sqrt{1 - (\omega_2^0/\lambda_1)^2}} \;\; \text{and} \;\;
A_3 = \frac{\omega_3^0}{\sqrt{1 - (\omega_2^0/\lambda_3)^2}}.
\end{equation}

By defining $x = {\omega_2}/{\lambda_\text{min}}$ and $\kappa = {\lambda_\text{min}}/{\lambda_\text{max}}$, where $\lambda_\text{min} = \min(\lambda_1,\lambda_3)$ and $\lambda_\text{max} = \max(\lambda_1,\lambda_3)$, we can transform the Euler equation for $\omega_2$ into to the following initial value problem for $x$:
\[
\begin{cases}
I_2 \lambda_\text{min} \dot{x} + (I_1-I_3) A_1 A_3 \sqrt{(1-x^2)(1-\kappa^2x^2)} = 0 \\
x(0) = \omega_2^0/\lambda_\text{min}.
\end{cases}
\]

The solution of the equation above and its application to 


can be expressed using the elliptic Jacobi function $\text{sn}$, so that we can calculate $\omega_2$ at any time as
\[
\omega_2(t) = \lambda_\text{min} \text{sn}(\alpha t + \epsilon,\kappa),
\]
where
\[
\alpha = -\frac{(I_1-I_3)A_1A_3}{\lambda_\text{min} I_2} \quad \text{and} \quad \epsilon = \text{arcsn}\left(\frac{\omega_{2,0}}{\lambda_\text{min}},\kappa\right).
\]

\bibliography{rigid_bodies}

\end{document}
